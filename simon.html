<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Simon Sequence</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');

        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; touch-action: manipulation; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 110px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        
        #rules-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); border: 2px solid #00ffcc; padding: 30px; z-index: 100; pointer-events: auto; text-align: center; width: 85%; max-width: 450px; box-shadow: 0 0 30px rgba(0,255,204,0.2); }
        
        .hud { display: flex; justify-content: space-between; width: 100%; pointer-events: auto; }
        .title { font-size: 20px; font-weight: bold; color: #fff; letter-spacing: 2px; }
        .hud-box { background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #333; margin-top: 5px; }
        
        .controls { display: flex; gap: 10px; pointer-events: auto; justify-content: center; width: 100%; flex-wrap: wrap; margin-bottom: 20px;}
        button { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px 15px; font-family: 'Space Mono'; cursor: pointer; text-transform: uppercase; font-size: 10px; transition: all 0.2s; }
        button:active { transform: translate(2px, 2px); }
        
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 20; pointer-events: auto; background: rgba(0,0,0,0.95); padding: 40px; border: 2px solid #ff0055; }
    </style>
</head>
<body>

    <div id="global-nav" style="position: absolute; top: 0; left: 0; width: 100%; z-index: 100; display: flex; justify-content: center; gap: 10px; padding: 15px 5px; background: rgba(0,0,0,0.85); border-bottom: 2px solid #333; pointer-events: auto; font-family: 'Space Mono', monospace; box-sizing: border-box; flex-wrap: wrap; font-size: 12px;">
        <a href="index.html" style="color: #ff8c00; text-decoration: none; font-weight: bold;">[1] SUNRISE</a> <span style="color: #555;">|</span>
        <a href="flappy.html" style="color: #00ffcc; text-decoration: none; font-weight: bold;">[2] FLAPPY</a> <span style="color: #555;">|</span>
        <a href="billiards.html" style="color: #ff00ff; text-decoration: none; font-weight: bold;">[3] WINDING</a> <span style="color: #555;">|</span>
        <a href="invaders.html" style="color: #ff0055; text-decoration: none; font-weight: bold;">[4] INVADERS</a> <span style="color: #555;">|</span>
        <a href="weaver.html" style="color: #b366ff; text-decoration: none; font-weight: bold;">[5] WEAVER</a> <span style="color: #555;">|</span>
        <a href="simon.html" style="color: #fff; text-decoration: none; font-weight: bold;">[6] SIMON</a>
    </div>

    <div id="rules-overlay">
        <h2 style="color: #00ffcc; margin-top: 0;">THE MONOLITH</h2>
        <p style="font-size: 12px; color: #aaa; text-align: left;">
            <strong>STANDARD MODE:</strong> The Monolith is silent. Watch the runic sequence it illuminates and repeat the exact notes back.<br><br>
            <strong>HARMONY MODE (HARD):</strong> Do not copy the notes. Play a harmonious interval over the requested note. Perfect 5ths score maximum points. Tritones and 2nds are dissonant and will instantly sever the uplink!
        </p>
        <button onclick="document.getElementById('rules-overlay').style.display='none'" style="margin-top: 15px;">COMMENCE</button>
    </div>

    <canvas id="c-simon"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <div>
                <div class="title">SIMON SEQUENCE</div>
                <div class="hud-box">
                    <div id="status-mode" style="color: #00ffcc; font-size: 10px; margin-bottom: 5px;">MODE: STANDARD (EXACT COPY)</div>
                    <div id="status-text" style="color: #ff8c00; font-size: 12px; font-weight: bold;">AWAITING UPLINK...</div>
                    <div id="harmony-feedback" style="color: #fff; font-size: 10px; margin-top: 5px;"></div>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 10px; color: #aaa;">SCORE</div>
                <div id="score-text" style="font-size: 24px; color: #0f0; font-weight: bold;">0</div>
            </div>
        </div>

        <div class="controls">
            <button id="btn-mic" style="border-color: #0f0; color: #0f0;">START MIC</button>
            <button id="btn-mode" style="border-color: #00ffcc; color: #00ffcc;">MODE: STANDARD</button>
        </div>
    </div>

    <div id="game-over">
        <h1 style="color: #ff0055; font-size: 24px;">UPLINK LOST</h1>
        <p id="death-reason" style="font-size: 12px; color: #aaa;"></p>
        <p style="font-size: 16px;">Final Score: <span id="final-score" style="color:#0f0; font-weight:bold;">0</span></p>
        <button id="btn-restart" style="border-color:#fff; color:#fff; margin-top:15px;">RETRY</button>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    import { notes, hzToPitchClass, colorPalettes } from './theory.js';

    const canvas = document.getElementById('c-simon');
    const ctx = canvas.getContext('2d');
    const audio = new AudioEngine();

    const btnMic = document.getElementById('btn-mic');
    const btnMode = document.getElementById('btn-mode');
    const btnRestart = document.getElementById('btn-restart');

    let gameState = 'IDLE'; 
    let gameMode = 'STANDARD'; // STANDARD or HARMONY
    let sequence = []; 
    let playerIndex = 0; 
    let score = 0;
    
    // Visuals
    let activeRuneIndex = -1;
    let visualMonolithGlow = 0;
    let visualMonolithColor = '#333';
    let hitCooldown = 0;

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    btnMode.addEventListener('click', () => {
        if (gameMode === 'STANDARD') {
            gameMode = 'HARMONY';
            btnMode.innerText = 'MODE: HARMONY';
            btnMode.style.borderColor = '#ff00ff'; btnMode.style.color = '#ff00ff';
            document.getElementById('status-mode').innerText = 'MODE: HARMONY (INTERVAL GRADING)';
            document.getElementById('status-mode').style.color = '#ff00ff';
        } else {
            gameMode = 'STANDARD';
            btnMode.innerText = 'MODE: STANDARD';
            btnMode.style.borderColor = '#00ffcc'; btnMode.style.color = '#00ffcc';
            document.getElementById('status-mode').innerText = 'MODE: STANDARD (EXACT COPY)';
            document.getElementById('status-mode').style.color = '#00ffcc';
        }
        if (gameState !== 'IDLE' && gameState !== 'GAMEOVER') triggerGameOver("MODE SWITCHED. UPLINK RESET.");
    });

    async function playSequence() {
        gameState = 'PLAYING';
        document.getElementById('status-text').innerText = "MONOLITH TRANSMITTING...";
        document.getElementById('status-text').style.color = "#00ffcc";
        document.getElementById('harmony-feedback').innerText = "";
        
        await new Promise(resolve => setTimeout(resolve, 800));
        
        for (let i = 0; i < sequence.length; i++) {
            let noteIdx = sequence[i];
            
            // 100% SILENT. Visuals only.
            visualMonolithColor = colorPalettes[Math.floor(noteIdx / 4)];
            visualMonolithGlow = 1.0;
            activeRuneIndex = noteIdx;
            
            await new Promise(resolve => setTimeout(resolve, 600)); 
            activeRuneIndex = -1;
            await new Promise(resolve => setTimeout(resolve, 200)); 
        }
        
        gameState = 'LISTENING';
        document.getElementById('status-text').innerText = "YOUR TURN: REPEAT SEQUENCE";
        document.getElementById('status-text').style.color = "#ff8c00";
        visualMonolithColor = '#333';
    }

    function addNoteToSequence() {
        sequence.push(Math.floor(Math.random() * 12));
        playSequence();
    }

    btnMic.addEventListener('click', async (e) => {
        if (await audio.startMic()) {
            e.target.style.display = 'none';
            sequence = []; score = 0; playerIndex = 0;
            document.getElementById('score-text').innerText = score;
            addNoteToSequence();
        }
    });

    btnRestart.addEventListener('click', () => {
        document.getElementById('game-over').style.display = 'none';
        sequence = []; score = 0; playerIndex = 0;
        document.getElementById('score-text').innerText = score;
        addNoteToSequence();
    });

    function triggerGameOver(reason) {
        gameState = 'GAMEOVER';
        document.getElementById('status-text').innerText = "UPLINK SEVERED.";
        document.getElementById('status-text').style.color = "#ff0055";
        document.getElementById('death-reason').innerText = reason;
        
        visualMonolithColor = '#ff0055';
        visualMonolithGlow = 1.0;
        
        document.getElementById('final-score').innerText = score;
        setTimeout(() => { document.getElementById('game-over').style.display = 'block'; }, 800);
    }

    function evaluateHarmony(played, expected) {
        let diff = (played - expected + 12) % 12;
        let feedback = document.getElementById('harmony-feedback');
        
        if (diff === 7) { // Perfect 5th
            score += 3;
            feedback.innerText = `P5 (+3): PERFECT HARMONY`; feedback.style.color = '#0f0';
            return true;
        } else if (diff === 5) { // Perfect 4th
            score += 2;
            feedback.innerText = `P4 (+2): STRONG HARMONY`; feedback.style.color = '#00ffcc';
            return true;
        } else if (diff === 3 || diff === 4 || diff === 8 || diff === 9) { // 3rds and 6ths
            score += 1;
            feedback.innerText = `(+1): CONSONANT HARMONY`; feedback.style.color = '#ff8c00';
            return true;
        } else if (diff === 0) { // Unison
            score += 1;
            feedback.innerText = `UNISON (+1): ACCEPTABLE`; feedback.style.color = '#aaa';
            return true;
        } else {
            // Tritone (6), Min 2nd (1), Maj 2nd (2), Min 7th (10), Maj 7th (11)
            feedback.innerText = `DISSONANCE DETECTED!`; feedback.style.color = '#ff0055';
            return false; // FAIL
        }
    }

    function renderFrame() {
        requestAnimationFrame(renderFrame);
        
        ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        let cx = canvas.width / 2; let cy = canvas.height / 2;

        if (hitCooldown > 0) hitCooldown--;

        if (gameState === 'LISTENING' && hitCooldown === 0 && audio.isRunning) {
            let peaks = audio.getPeaks(100);
            if (peaks.length > 0) {
                let playedNoteIdx = hzToPitchClass(peaks[0].hz);
                
                if (playedNoteIdx !== -1) {
                    let expectedNoteIdx = sequence[playerIndex];
                    
                    visualMonolithColor = colorPalettes[Math.floor(playedNoteIdx / 4)];
                    visualMonolithGlow = 0.8;
                    activeRuneIndex = playedNoteIdx;
                    
                    let passed = false;

                    if (gameMode === 'STANDARD') {
                        if (playedNoteIdx === expectedNoteIdx) {
                            score++; passed = true;
                            document.getElementById('harmony-feedback').innerText = "MATCH CONFIRMED";
                            document.getElementById('harmony-feedback').style.color = "#0f0";
                        } else {
                            triggerGameOver(`WRONG NOTE. EXPECTED: ${notes[expectedNoteIdx]}`);
                        }
                    } else if (gameMode === 'HARMONY') {
                        passed = evaluateHarmony(playedNoteIdx, expectedNoteIdx);
                        if (!passed) {
                            triggerGameOver(`FATAL DISSONANCE DETECTED.`);
                        }
                    }

                    if (passed) {
                        playerIndex++;
                        hitCooldown = 40; // Prevent double-triggering
                        document.getElementById('score-text').innerText = score;
                        
                        setTimeout(() => { activeRuneIndex = -1; }, 400);

                        if (playerIndex >= sequence.length) {
                            playerIndex = 0;
                            gameState = 'SUCCESS';
                            document.getElementById('status-text').innerText = "PATTERN ACCEPTED. PREPARING NEXT...";
                            document.getElementById('status-text').style.color = "#0f0";
                            visualMonolithColor = '#0f0'; visualMonolithGlow = 1.0;
                            setTimeout(addNoteToSequence, 1500);
                        }
                    }
                }
            }
        }

        // Draw Visuals
        visualMonolithGlow = Math.max(0, visualMonolithGlow - 0.03);
        let radius = Math.min(canvas.width, canvas.height) * 0.35;
        
        ctx.lineWidth = 2;
        for (let i = 0; i < 12; i++) {
            let angle = (i * Math.PI / 6) - (Math.PI / 2);
            let rx = cx + Math.cos(angle) * radius; let ry = cy + Math.sin(angle) * radius;
            
            if (i === activeRuneIndex) {
                ctx.fillStyle = visualMonolithColor; ctx.shadowBlur = 20; ctx.shadowColor = visualMonolithColor;
            } else {
                ctx.fillStyle = '#222'; ctx.shadowBlur = 0;
            }
            
            ctx.beginPath();
            ctx.moveTo(rx, ry - 10); ctx.lineTo(rx + 10, ry);
            ctx.lineTo(rx, ry + 10); ctx.lineTo(rx - 10, ry);
            ctx.closePath(); ctx.fill();
            
            ctx.fillStyle = (i === activeRuneIndex) ? '#fff' : '#555';
            ctx.font = '12px monospace'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(notes[i], cx + Math.cos(angle) * (radius + 25), cy + Math.sin(angle) * (radius + 25));
        }

        // Draw Crystal Monolith
        ctx.shadowBlur = visualMonolithGlow * 50; ctx.shadowColor = visualMonolithColor;
        let mWidth = 60, mHeight = 180;
        
        ctx.fillStyle = visualMonolithGlow > 0.1 ? visualMonolithColor : '#111';
        ctx.strokeStyle = visualMonolithColor;
        
        ctx.beginPath();
        ctx.moveTo(cx, cy - mHeight/2 - 30); ctx.lineTo(cx + mWidth/2, cy - mHeight/2); 
        ctx.lineTo(cx + mWidth/2, cy + mHeight/2); ctx.lineTo(cx, cy + mHeight/2 + 30); 
        ctx.lineTo(cx - mWidth/2, cy + mHeight/2); ctx.lineTo(cx - mWidth/2, cy - mHeight/2); 
        ctx.closePath(); ctx.fill();
        if (visualMonolithGlow > 0) ctx.stroke();
        ctx.shadowBlur = 0;

        if (visualMonolithGlow > 0.1) {
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(cx, cy - mHeight/2 - 20); ctx.lineTo(cx, cy + mHeight/2 + 20); ctx.stroke();
        }
    }

    renderFrame();
</script>
</body>
</html>