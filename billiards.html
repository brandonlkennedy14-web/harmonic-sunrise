<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Winding Room</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');
        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 110px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        .hud-box { background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #333; pointer-events: auto; }
        button { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px; cursor: pointer; pointer-events: auto; }
    </style>
</head>
<body>
    <canvas id="c-billiards"></canvas>
    <div id="ui-layer">
        <div class="hud-box">
            <div style="color:#ff00ff;">WINDING ROOM</div>
            <div id="hud-ratio" style="font-size:10px; color:#00ffcc;">RATIO: --</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button id="btn-mic">START MIC</button>
            <button id="btn-shoot" style="display:none; border-color:#ff8c00;">FIRE</button>
        </div>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    const audio = new AudioEngine();
    const canvas = document.getElementById('c-billiards');
    const ctx = canvas.getContext('2d');

    let sqSize, sqX, sqY, ball = { x: 0, y: 0, vx: 0, vy: 0, active: false }, ratio = 1.0;

    function resize() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        sqSize = Math.min(canvas.width, canvas.height) * 0.6;
        sqX = (canvas.width - sqSize)/2; sqY = (canvas.height - sqSize)/2 + 40;
        resetBall();
    }
    window.addEventListener('resize', resize); resize();

    function resetBall() { ball.active = false; ball.x = sqX; ball.y = sqY + sqSize; }

    document.getElementById('btn-mic').addEventListener('click', async (e) => {
        if (await audio.startMic()) e.target.style.display = 'none';
    });

    document.getElementById('btn-shoot').addEventListener('click', () => {
        ball.active = true;
        // Fix: Use trigonometry for launch angle based on ratio
        let angle = Math.atan(ratio);
        ball.vx = Math.cos(angle) * 6;
        ball.vy = -Math.sin(angle) * 6;
        document.getElementById('btn-shoot').style.display = 'none';
    });

    function render() {
        requestAnimationFrame(render);
        ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        let peaks = audio.getPeaks(85);
        if (peaks.length >= 2) {
            ratio = Math.max(peaks[0].hz, peaks[1].hz) / Math.min(peaks[0].hz, peaks[1].hz);
            document.getElementById('hud-ratio').innerText = `RATIO: ${ratio.toFixed(4)}`;
            if (!ball.active) document.getElementById('btn-shoot').style.display = 'block';
        }

        ctx.strokeStyle = '#444'; ctx.strokeRect(sqX, sqY, sqSize, sqSize);

        if (ball.active) {
            ball.x += ball.vx; ball.y += ball.vy;
            if (ball.x <= sqX || ball.x >= sqX + sqSize) ball.vx *= -1;
            if (ball.y <= sqY || ball.y >= sqY + sqSize) ball.vy *= -1;
        }

        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(ball.x, ball.y, 6, 0, Math.PI*2); ctx.fill();
    }
    render();
</script>
</body>
</html>