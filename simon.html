<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Simon Sequence</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Space+Mono:wght@400;700&display=swap');
        * { box-sizing: border-box; }
        body { margin:0; padding:0; background:#000; color:#fff; font-family:'Space Mono',monospace; overflow:hidden; touch-action:manipulation; }

        canvas { display:block; width:100vw; height:100vh; position:absolute; top:0; left:0; image-rendering:pixelated; }
        #c-stars  { z-index:1; }
        #c-ruliad { z-index:2; }
        #c-game   { z-index:3; background:transparent; }
        #c-munker { z-index:4; pointer-events:none; }

        #ui-layer {
            position:absolute; top:0; left:0; width:100%; height:100%;
            z-index:10; display:flex; flex-direction:column;
            justify-content:space-between; padding:110px 20px 20px 20px; pointer-events:none;
        }
        .hud { display:flex; justify-content:space-between; width:100%; pointer-events:auto; }
        .title { font-size:18px; font-weight:bold; color:#fff; letter-spacing:3px; }
        .hud-box { background:rgba(0,0,0,0.8); padding:8px 12px; border:2px solid #333; margin-top:8px; font-size:10px; letter-spacing:1px; transition:border-color 0.4s; }
        .controls { display:flex; gap:10px; pointer-events:auto; justify-content:center; flex-wrap:wrap; }
        button { background:rgba(0,0,0,0.8); border:2px solid #fff; color:#fff; padding:10px 15px; font-family:'Space Mono',monospace; font-size:10px; cursor:pointer; text-transform:uppercase; letter-spacing:1px; transition:all 0.15s; }
        button:active { transform:translate(2px,2px); }

        #rules-overlay {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            background:rgba(0,0,0,0.96); border:2px solid #00ffcc;
            padding:30px; z-index:100; pointer-events:auto; text-align:center;
            width:85%; max-width:460px; box-shadow:0 0 30px rgba(0,255,204,0.2);
        }

        #game-over {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            text-align:center; display:none; z-index:20; pointer-events:auto;
            background:rgba(0,0,0,0.96); padding:40px 50px; border:3px solid #ff0055;
        }
        #game-over h1 { color:#ff0055; margin:0 0 12px 0; font-size:22px; letter-spacing:3px; }

        #pitch-accent { position:absolute; top:0; left:0; width:100%; height:3px; z-index:15; pointer-events:none; transition:background 0.5s; }
    
    

    /* ── MATRIX TERMINAL SKIN ──────────────────────────────────────────────── */
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

    :root {
        --m-green: #00ff41;
        --m-mid:   #00cc33;
        --m-dim:   #00661a;
        --m-bg:    #000300;
        --m-panel: #010a01;
        --m-glow:  0 0 8px #00ff41, 0 0 20px rgba(0,255,65,0.5);
        --m-font:  'VT323', 'Courier New', monospace;
    }

    * {
        font-family: var(--m-font) !important;
        letter-spacing: 2px !important;
    }

    body {
        background: var(--m-bg) !important;
        color: var(--m-green) !important;
        font-family: var(--m-font) !important;
        font-size: 16px !important;
    }

    #global-nav {
        background: rgba(0,3,0,0.95) !important;
        border-bottom: 1px solid var(--m-dim) !important;
        font-family: var(--m-font) !important;
        font-size: 14px !important;
    }
    #global-nav a {
        font-family: var(--m-font) !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        font-size: 14px !important;
    }
    #global-nav span { color: #003311 !important; }

    #mode-tabs { background: rgba(0,3,0,0.95) !important; border-bottom-color: #003311 !important; }
    .tab-btn {
        font-family: var(--m-font) !important;
        font-size: 13px !important;
        color: #003311 !important;
    }
    .tab-btn.active {
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        border-bottom-color: var(--m-green) !important;
        background: rgba(0,255,65,0.05) !important;
    }

    .title, #main-title, #mode-title {
        font-family: var(--m-font) !important;
        font-size: 26px !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        letter-spacing: 5px !important;
    }

    .hud-box, #hud-box {
        font-family: var(--m-font) !important;
        background: var(--m-panel) !important;
        border: 1px solid var(--m-dim) !important;
    }
    .hud-box *, #hud-box * {
        font-family: var(--m-font) !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        font-size: 15px !important;
    }

    .ratio-box {
        font-family: var(--m-font) !important;
        background: var(--m-panel) !important;
        border-left: 3px solid var(--m-green) !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        font-size: 15px !important;
    }

    #score-text, .score-display, .score-text {
        font-family: var(--m-font) !important;
        font-size: 42px !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        letter-spacing: 4px !important;
    }

    .subtitle, .high-score, #best-text, #high-score-text {
        font-family: var(--m-font) !important;
        color: var(--m-mid) !important;
        font-size: 13px !important;
    }

    button {
        font-family: var(--m-font) !important;
        font-size: 15px !important;
        background: var(--m-panel) !important;
        border: 1px solid var(--m-green) !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        box-shadow: 0 0 8px rgba(0,255,65,0.2),
                    inset 0 0 10px rgba(0,255,65,0.05) !important;
        letter-spacing: 3px !important;
        border-radius: 0 !important;
        padding: 10px 16px !important;
    }
    button:hover {
        background: rgba(0,255,65,0.08) !important;
        box-shadow: 0 0 14px rgba(0,255,65,0.35) !important;
    }

    #status-text, #status-mode, #status-note, #status-register,
    #hud-ratio, #hud-extra, #hud-level, #hud-note, #hud-upgrade,
    #launch-warn, #status-health, #power-meter,
    #val-current, #val-interval, #val-target,
    .data-text, .data-value, .data-label,
    .target-text, .reg-label, #mode-hint,
    #harmony-feedback, #hud-last, #hud-rise, #hud-dawn {
        font-family: var(--m-font) !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
        font-size: 15px !important;
    }

    #game-over, #result-panel, #rules-overlay {
        font-family: var(--m-font) !important;
        background: #000500 !important;
        border: 1px solid var(--m-green) !important;
        box-shadow: 0 0 40px rgba(0,255,65,0.25),
                    inset 0 0 30px rgba(0,255,65,0.03) !important;
        color: var(--m-green) !important;
    }
    #game-over *, #result-panel *, #rules-overlay * {
        font-family: var(--m-font) !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
    }
    #game-over h1, #result-title {
        font-size: 36px !important;
        letter-spacing: 6px !important;
    }

    #level-banner {
        font-family: var(--m-font) !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
    }

    .reg-label, #lbl-high, #lbl-mid, #lbl-bass {
        font-family: var(--m-font) !important;
        font-size: 14px !important;
        color: var(--m-green) !important;
        text-shadow: var(--m-glow) !important;
    }

    #pitch-accent { opacity: 0.6 !important; filter: hue-rotate(80deg) saturate(2) !important; }

    #monolith-ambient {
        background: radial-gradient(ellipse at bottom,
            rgba(0,255,65,0.06) 0%, transparent 70%) !important;
    }
    /* ── END MATRIX TERMINAL SKIN ─────────────────────────────────────────── */
</style>
</head>
<body>

<div id="global-nav" style="position:absolute;top:0;left:0;width:100%;z-index:100;display:flex;justify-content:center;gap:10px;padding:14px 5px;background:rgba(0,0,0,0.92);border-bottom:2px solid #222;pointer-events:auto;font-family:'Space Mono',monospace;box-sizing:border-box;flex-wrap:wrap;font-size:11px;letter-spacing:1px;">
    <a href="index.html"     style="color:#ff8c00;text-decoration:none;font-weight:bold;">[1] SUNRISE</a>  <span style="color:#444;">|</span>
    <a href="flappy.html"    style="color:#00ffcc;text-decoration:none;font-weight:bold;">[2] FLAPPY</a>   <span style="color:#444;">|</span>
    <a href="billiards.html" style="color:#ff00ff;text-decoration:none;font-weight:bold;">[3] WINDING</a>  <span style="color:#444;">|</span>
    <a href="invaders.html"  style="color:#ff0055;text-decoration:none;font-weight:bold;">[4] INVADERS</a> <span style="color:#444;">|</span>
    <a href="weaver.html"    style="color:#b366ff;text-decoration:none;font-weight:bold;">[5] WEAVER</a>   <span style="color:#444;">|</span>
    <a href="simon.html"     style="color:#fff;text-decoration:none;font-weight:bold;">[6] SIMON</a>
</div>

<div id="rules-overlay">
    <h2 style="color:#00ffcc;margin-top:0;letter-spacing:3px;">THE MONOLITH</h2>
    <p style="font-size:11px;color:#aaa;text-align:left;line-height:1.8;">
        <strong style="color:#fff;">STANDARD MODE:</strong> The Monolith illuminates a sequence of runes. Watch, then repeat the exact notes back.<br><br>
        <strong style="color:#fff;">HARMONY MODE:</strong> Do not copy — play a harmonious interval over each note. Perfect 5ths score maximum. Tritones and 2nds sever the uplink instantly.
    </p>
    <button onclick="document.getElementById('rules-overlay').style.display='none'" style="margin-top:15px;border-color:#00ffcc;color:#00ffcc;">COMMENCE</button>
</div>

<div id="pitch-accent"></div>
<canvas id="c-stars"></canvas>
<canvas id="c-ruliad"></canvas>
<canvas id="c-game"></canvas>
<canvas id="c-munker"></canvas>

<div id="ui-layer">
    <div class="hud">
        <div>
            <div class="title">SIMON SEQUENCE</div>
            <div class="hud-box" id="hud-box">
                <div id="status-mode" style="color:#00ffcc;margin-bottom:4px;">MODE: STANDARD</div>
                <div id="status-text" style="color:#ff8c00;font-weight:bold;">AWAITING UPLINK…</div>
                <div id="harmony-feedback" style="margin-top:4px;font-size:9px;"></div>
            </div>
        </div>
        <div style="text-align:right;">
            <div style="font-size:9px;color:#aaa;letter-spacing:1px;">SCORE</div>
            <div id="score-text" style="font-size:26px;color:#0f0;font-weight:bold;">0</div>
        </div>
    </div>
    <div class="controls">
        <button id="btn-mic" style="border-color:#0f0;color:#0f0;">START MIC</button>
        <button id="btn-mode" style="border-color:#00ffcc;color:#00ffcc;">MODE: STANDARD</button>
    </div>
</div>

<div id="game-over">
    <h1>UPLINK LOST</h1>
    <p id="death-reason" style="font-size:11px;color:#aaa;letter-spacing:1px;"></p>
    <p>Score: <span id="final-score" style="color:#0f0;font-weight:bold;font-size:20px;">0</span></p>
    <button id="btn-restart" style="border-color:#fff;color:#fff;margin-top:15px;">RETRY</button>
</div>

<script>
// ─────────────────────────────────────────────────────────────────────────────
// AUDIO ENGINE
// ─────────────────────────────────────────────────────────────────────────────
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const KEY_HUES  = [0,30,55,80,110,145,175,200,230,265,295,330];
function keyHSL(pc,s=100,l=55){ return `hsl(${KEY_HUES[pc]},${s}%,${l}%)`; }
function lerpHue(a,b,t){ let d=b-a; if(d>180)d-=360; if(d<-180)d+=360; return(a+d*t+360)%360; }
function hzToPitchClass(hz){ if(hz<=0)return -1; let h=Math.round(12*Math.log2(hz/16.35)); return((h%12)+12)%12; }

// Color palette per note group (for monolith glow — kept grey, Munker tints it)
const NOTE_COLORS = KEY_HUES.map(h=>`hsl(${h},100%,60%)`);

class AudioEngine {
    constructor(){ this.audioContext=null;this.analyser=null;this.microphone=null;this.isRunning=false;this.dataArray=null; }
    async startMic(){
        try{
            this.audioContext=new(window.AudioContext||window.webkitAudioContext)();
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            this.microphone=this.audioContext.createMediaStreamSource(stream);
            this.analyser=this.audioContext.createAnalyser();
            this.analyser.fftSize=8192; this.analyser.smoothingTimeConstant=0.75;
            this.microphone.connect(this.analyser);
            this.dataArray=new Uint8Array(this.analyser.frequencyBinCount);
            this.isRunning=true; return true;
        }catch(e){ console.error(e); return false; }
    }
    getPeaks(threshold=90){
        if(!this.isRunning)return[];
        this.analyser.getByteFrequencyData(this.dataArray);
        const sr=this.audioContext.sampleRate, binHz=sr/this.analyser.fftSize;
        const lo=Math.floor(80/binHz), hi=Math.floor(3000/binHz);
        let maxVal=0,maxIdx=-1;
        for(let i=lo;i<hi&&i<this.dataArray.length;i++){
            if(this.dataArray[i]>maxVal){maxVal=this.dataArray[i];maxIdx=i;}
        }
        if(maxVal>threshold)return[{hz:maxIdx*binHz,amp:maxVal}];
        return[];
    }
}
const audio = new AudioEngine();

// ─────────────────────────────────────────────────────────────────────────────
// CANVAS
// ─────────────────────────────────────────────────────────────────────────────
const cStars=document.getElementById('c-stars'),   ctxS=cStars.getContext('2d');
const cRuliad=document.getElementById('c-ruliad'), ctxR=cRuliad.getContext('2d');
const cGame=document.getElementById('c-game'),     ctx=cGame.getContext('2d');
const cMunker=document.getElementById('c-munker'), ctxM=cMunker.getContext('2d');
let W,H,cx,cy;

// ─────────────────────────────────────────────────────────────────────────────
// SHARED VISUALS
// ─────────────────────────────────────────────────────────────────────────────
let stars=[],rulCells,rulNext,rulCols,rulRows,frames=0;
const RUL=10;
let munkerH1=175,munkerH2=295,munkerT1=175,munkerT2=295;

function initVisuals(){
    rulCols=Math.ceil(W/RUL)+1; rulRows=Math.ceil(H/RUL)+1;
    rulCells=new Uint8Array(rulCols*rulRows); rulNext=new Uint8Array(rulCols*rulRows);
    for(let i=0;i<rulCells.length;i++) rulCells[i]=Math.random()<0.32?1:0;
    stars=[];
    for(let i=0;i<280;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()<0.1?2:1,bri:0.15+Math.random()*0.85,tw:Math.random()*Math.PI*2});
}
function stepRuliad(){
    for(let y=0;y<rulRows;y++) for(let x=0;x<rulCols;x++){
        const i=y*rulCols+x; let n=0;
        for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
            if(dx===0&&dy===0)continue;
            n+=rulCells[((y+dy+rulRows)%rulRows)*rulCols+(x+dx+rulCols)%rulCols];
        }
        const a=rulCells[i]; rulNext[i]=a?((n===2||n===3)?1:0):((n===3||n===6)?1:0);
    }
    let t=rulCells;rulCells=rulNext;rulNext=t;
}
function drawStars(pc){
    ctxS.fillStyle='#000'; ctxS.fillRect(0,0,W,H);
    stars.forEach(s=>{
        const tw=0.5+0.5*Math.sin(s.tw+frames*0.015);
        ctxS.fillStyle=pc>=0?`hsla(${KEY_HUES[pc]},60%,85%,${s.bri*tw*0.9})`:`rgba(255,255,255,${s.bri*tw*0.85})`;
        ctxS.fillRect(s.x,s.y,s.r,s.r);
    });
}
function drawRuliad(pc){
    ctxR.clearRect(0,0,W,H);
    const hue=pc>=0?KEY_HUES[pc]:175;
    for(let y=0;y<rulRows;y++) for(let x=0;x<rulCols;x++){
        if(rulCells[y*rulCols+x]){
            ctxR.fillStyle=`hsla(${hue},65%,55%,0.13)`;
            ctxR.fillRect(x*RUL,y*RUL,RUL-1,RUL-1);
        }
    }
}
function drawMunker(h1,h2,op=0.46){
    ctxM.clearRect(0,0,W,H);
    const S=16;
    for(let y=0;y<H;y++){
        const m=y%S;
        if(m<2)               {ctxM.fillStyle=`hsla(${h1},100%,58%,${op})`;  ctxM.fillRect(0,y,W,1);}
        else if(m>=S/2&&m<S/2+2){ctxM.fillStyle=`hsla(${h2},100%,58%,${op})`;ctxM.fillRect(0,y,W,1);}
        else if(m===3||m===S/2-1){ctxM.fillStyle=`rgba(0,0,0,0.5)`;          ctxM.fillRect(0,y,W,1);}
    }
}

// ─────────────────────────────────────────────────────────────────────────────
// CRYSTAL MONOLITH — drawn grey, Munker overlay colours it
// ─────────────────────────────────────────────────────────────────────────────
let monolithGlow=0, monolithGrey=0.08; // 0=dark, 1=bright
let monolithFlash=0;

function drawMonolith(activeNote){
    const mW=70, mH=200;
    const mx=cx, my=cy;

    // Inner crystal fill — grey value responds to glow
    const grey=Math.floor(20+monolithGlow*180);
    const greyStr=`rgb(${grey},${grey},${grey+20})`;

    // Outer glow (ctx shadow — grey so Munker tints it)
    ctx.shadowBlur=monolithGlow*60; ctx.shadowColor=`rgba(180,180,220,${monolithGlow})`;

    // Main slab — hexagonal pixel shape
    ctx.fillStyle=greyStr;
    ctx.beginPath();
    ctx.moveTo(mx,          my-mH/2-28);
    ctx.lineTo(mx+mW/2,     my-mH/2);
    ctx.lineTo(mx+mW/2,     my+mH/2);
    ctx.lineTo(mx,          my+mH/2+28);
    ctx.lineTo(mx-mW/2,     my+mH/2);
    ctx.lineTo(mx-mW/2,     my-mH/2);
    ctx.closePath(); ctx.fill();

    // Edge facets — slightly lighter
    ctx.fillStyle=`rgb(${grey+30},${grey+30},${grey+50})`;
    ctx.beginPath();
    ctx.moveTo(mx+mW/2,     my-mH/2);
    ctx.lineTo(mx+mW/2+8,   my-mH/2+12);
    ctx.lineTo(mx+mW/2+8,   my+mH/2-12);
    ctx.lineTo(mx+mW/2,     my+mH/2);
    ctx.closePath(); ctx.fill();

    // Vertical centre seam
    if(monolithGlow>0.1){
        ctx.strokeStyle=`rgba(220,220,255,${monolithGlow*0.6})`;
        ctx.lineWidth=1.5;
        ctx.beginPath(); ctx.moveTo(mx,my-mH/2-20); ctx.lineTo(mx,my+mH/2+20); ctx.stroke();
        // Horizontal crack lines
        ctx.strokeStyle=`rgba(200,200,240,${monolithGlow*0.3})`;
        ctx.lineWidth=1;
        for(let i=1;i<5;i++){
            const ly=my-mH/2+i*(mH/5);
            ctx.beginPath(); ctx.moveTo(mx-mW/2+8,ly); ctx.lineTo(mx+mW/2-8,ly); ctx.stroke();
        }
    }

    ctx.shadowBlur=0;

    // 12 rune diamonds in a circle around monolith
    const radius=Math.min(W,H)*0.34;
    for(let i=0;i<12;i++){
        const angle=(i*Math.PI/6)-(Math.PI/2);
        const rx=cx+Math.cos(angle)*radius;
        const ry=cy+Math.sin(angle)*radius;
        const isActive=(i===activeNote);
        const runeGrey=isActive?220:40;

        ctx.shadowBlur=isActive?25:0;
        ctx.shadowColor=`rgba(200,200,255,0.9)`;
        ctx.fillStyle=`rgb(${runeGrey},${runeGrey},${runeGrey+10})`;
        // Diamond shape
        ctx.beginPath();
        ctx.moveTo(rx,ry-11); ctx.lineTo(rx+11,ry); ctx.lineTo(rx,ry+11); ctx.lineTo(rx-11,ry);
        ctx.closePath(); ctx.fill();
        ctx.shadowBlur=0;

        // Note label
        ctx.fillStyle=isActive?'#fff':'#666';
        ctx.font=isActive?'bold 11px monospace':'10px monospace';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText(noteNames[i], rx, ry);
    }

    // Connecting ring (faint)
    ctx.strokeStyle='rgba(120,120,160,0.2)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.stroke();
}

// ─────────────────────────────────────────────────────────────────────────────
// GAME STATE
// ─────────────────────────────────────────────────────────────────────────────
let gameState='IDLE', gameMode='STANDARD';
let sequence=[], playerIndex=0, score=0;
let activeRuneIndex=-1, hitCooldown=0;
let currentPc=-1;

function startMic_start(){
    sequence=[]; score=0; playerIndex=0;
    document.getElementById('score-text').innerText=0;
    addNoteToSequence();
}

async function playSequence(){
    gameState='PLAYING';
    document.getElementById('status-text').innerText='MONOLITH TRANSMITTING…';
    document.getElementById('status-text').style.color='#00ffcc';
    document.getElementById('harmony-feedback').innerText='';
    await delay(800);
    for(let i=0;i<sequence.length;i++){
        const ni=sequence[i];
        activeRuneIndex=ni;
        munkerT1=KEY_HUES[ni]; munkerT2=KEY_HUES[(ni+7)%12];
        monolithGlow=1.0;
        await delay(600);
        activeRuneIndex=-1; monolithGlow=0.05;
        await delay(200);
    }
    gameState='LISTENING';
    document.getElementById('status-text').innerText='YOUR TURN: REPEAT SEQUENCE';
    document.getElementById('status-text').style.color='#ff8c00';
}

function addNoteToSequence(){
    sequence.push(Math.floor(Math.random()*12));
    playSequence();
}

function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

function evaluateHarmony(played,expected){
    const diff=(played-expected+12)%12;
    const fb=document.getElementById('harmony-feedback');
    if(diff===7){score+=3;fb.innerText='P5 (+3): PERFECT HARMONY';fb.style.color='#0f0';return true;}
    if(diff===5){score+=2;fb.innerText='P4 (+2): STRONG HARMONY';fb.style.color='#00ffcc';return true;}
    if([3,4,8,9].includes(diff)){score+=1;fb.innerText='(+1): CONSONANT';fb.style.color='#ff8c00';return true;}
    if(diff===0){score+=1;fb.innerText='UNISON (+1): ACCEPTABLE';fb.style.color='#aaa';return true;}
    fb.innerText='DISSONANCE DETECTED!'; fb.style.color='#ff0055'; return false;
}

function triggerGameOver(reason){
    gameState='GAMEOVER';
    monolithGlow=1.0; munkerT1=0; munkerT2=0;
    document.getElementById('status-text').innerText='UPLINK SEVERED.';
    document.getElementById('status-text').style.color='#ff0055';
    document.getElementById('death-reason').innerText=reason;
    document.getElementById('final-score').innerText=score;
    setTimeout(()=>document.getElementById('game-over').style.display='block',800);
}

// ─────────────────────────────────────────────────────────────────────────────
// EVENT LISTENERS
// ─────────────────────────────────────────────────────────────────────────────
document.getElementById('btn-mic').addEventListener('click',async e=>{
    if(await audio.startMic()){ e.target.style.display='none'; startMic_start(); }
});
document.getElementById('btn-restart').addEventListener('click',()=>{
    document.getElementById('game-over').style.display='none'; startMic_start();
});
document.getElementById('btn-mode').addEventListener('click',()=>{
    gameMode=gameMode==='STANDARD'?'HARMONY':'STANDARD';
    const btn=document.getElementById('btn-mode');
    const sm=document.getElementById('status-mode');
    if(gameMode==='HARMONY'){
        btn.innerText='MODE: HARMONY'; btn.style.borderColor='#ff00ff'; btn.style.color='#ff00ff';
        sm.innerText='MODE: HARMONY (INTERVAL)'; sm.style.color='#ff00ff';
    } else {
        btn.innerText='MODE: STANDARD'; btn.style.borderColor='#00ffcc'; btn.style.color='#00ffcc';
        sm.innerText='MODE: STANDARD'; sm.style.color='#00ffcc';
    }
    if(gameState!=='IDLE'&&gameState!=='GAMEOVER') triggerGameOver('MODE SWITCHED. UPLINK RESET.');
});

// ─────────────────────────────────────────────────────────────────────────────
// RESIZE
// ─────────────────────────────────────────────────────────────────────────────
function resize(){
    W=window.innerWidth; H=window.innerHeight; cx=W/2; cy=H/2;
    [cStars,cRuliad,cGame,cMunker].forEach(c=>{c.width=W;c.height=H;});
    initVisuals();
}
window.addEventListener('resize',resize);

// ─────────────────────────────────────────────────────────────────────────────
// MAIN LOOP
// ─────────────────────────────────────────────────────────────────────────────
function renderFrame(){
    requestAnimationFrame(renderFrame);
    frames++;

    // Visuals
    munkerH1=lerpHue(munkerH1,munkerT1,0.05);
    munkerH2=lerpHue(munkerH2,munkerT2,0.05);
    if(frames%4===0) stepRuliad();
    drawRuliad(currentPc);
    if(frames%3===0) drawStars(currentPc);
    ctx.clearRect(0,0,W,H);
    if(frames%2===0) drawMunker(munkerH1,munkerH2);

    // Glow decay
    monolithGlow=Math.max(0.04,monolithGlow-0.025);

    // Audio (only during LISTENING)
    if(gameState==='LISTENING'&&hitCooldown===0&&audio.isRunning){
        const peaks=audio.getPeaks(90);
        if(peaks.length>0){
            const pc=hzToPitchClass(peaks[0].hz);
            if(pc>=0){
                currentPc=pc;
                munkerT1=KEY_HUES[pc]; munkerT2=KEY_HUES[(pc+7)%12];
                document.getElementById('pitch-accent').style.background=
                    `linear-gradient(90deg,hsl(${munkerT1},100%,55%),hsl(${munkerT2},100%,55%))`;
                document.getElementById('hud-box').style.borderColor=keyHSL(pc,70,55);

                activeRuneIndex=pc; monolithGlow=0.8;

                const expected=sequence[playerIndex];
                let passed=false;
                if(gameMode==='STANDARD'){
                    if(pc===expected){ score++; passed=true;
                        document.getElementById('harmony-feedback').innerText='MATCH CONFIRMED';
                        document.getElementById('harmony-feedback').style.color='#0f0';
                    } else { triggerGameOver(`WRONG NOTE. EXPECTED: ${noteNames[expected]}`); }
                } else {
                    passed=evaluateHarmony(pc,expected);
                    if(!passed) triggerGameOver('FATAL DISSONANCE.');
                }

                if(passed){
                    playerIndex++; hitCooldown=40;
                    document.getElementById('score-text').innerText=score;
                    setTimeout(()=>{ activeRuneIndex=-1; },400);
                    if(playerIndex>=sequence.length){
                        playerIndex=0; gameState='SUCCESS';
                        document.getElementById('status-text').innerText='PATTERN ACCEPTED…';
                        document.getElementById('status-text').style.color='#0f0';
                        monolithGlow=1.0;
                        setTimeout(addNoteToSequence,1500);
                    }
                }
            }
        }
    }
    if(hitCooldown>0) hitCooldown--;

    // Draw
    drawMonolith(activeRuneIndex);
}

// Boot
resize();
renderFrame();
</script>
</body>
</html>
