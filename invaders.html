<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonic Invaders</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');

        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 70px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        .hud { display: flex; justify-content: space-between; width: 100%; pointer-events: auto; }
        .title { font-size: 20px; font-weight: bold; color: #ff0055; letter-spacing: 2px; }
        .score-display { font-size: 24px; color: #0f0; font-weight: bold; }
        
        .hud-box { background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #333; margin-top: 10px; width: fit-content; }
        .health-text { color: #00ffcc; font-size: 14px; font-weight: bold;}

        .controls { display: flex; gap: 10px; pointer-events: auto; }
        button { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px 15px; font-family: 'Space Mono', monospace; font-size: 10px; cursor: pointer; text-transform: uppercase; transition: all 0.2s; }
        button:active { transform: translate(2px, 2px); }

        #btn-mic { border-color: #0f0; color: #0f0; }
        
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 20; pointer-events: auto; background: rgba(0,0,0,0.9); padding: 40px; border: 2px solid #ff0055; }
        #game-over h1 { color: #ff0055; margin: 0 0 20px 0; }
    </style>
</head>
<body>

    <div id="global-nav" style="position: absolute; top: 0; left: 0; width: 100%; z-index: 100; display: flex; justify-content: center; gap: 10px; padding: 15px 5px; background: rgba(0,0,0,0.85); border-bottom: 2px solid #333; pointer-events: auto; font-family: 'Space Mono', monospace; box-sizing: border-box; flex-wrap: wrap; font-size: 12px;">
        <a href="index.html" style="color: #ff8c00; text-decoration: none; font-weight: bold; transition: color 0.2s;">[1] SUNRISE</a>
        <span style="color: #555;">|</span>
        <a href="flappy.html" style="color: #00ffcc; text-decoration: none; font-weight: bold; transition: color 0.2s;">[2] FLAPPY</a>
        <span style="color: #555;">|</span>
        <a href="billiards.html" style="color: #ff00ff; text-decoration: none; font-weight: bold; transition: color 0.2s;">[3] WINDING</a>
        <span style="color: #555;">|</span>
        <a href="invaders.html" style="color: #ff0055; text-decoration: none; font-weight: bold; transition: color 0.2s;">[4] INVADERS</a>
        <span style="color: #555;">|</span>
        <span style="color: #777; font-weight: bold; opacity: 0.5; cursor: not-allowed;">[5] WEAVER</span>
        <span style="color: #555;">|</span>
        <span style="color: #777; font-weight: bold; opacity: 0.5; cursor: not-allowed;">[6] SIMON</span>
    </div>

    <canvas id="c-invaders"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <div>
                <div class="title">HARMONIC INVADERS</div>
                <div class="hud-box">
                    <div id="status-health" class="health-text">CITY INTEGRITY: 100%</div>
                    <div id="status-note" style="color:#aaa; font-size:10px; margin-top:5px;">PLAY NOTE TO FIRE</div>
                </div>
            </div>
            <div class="score-display" id="score-text">0</div>
        </div>

        <div class="controls">
            <button id="btn-mic">START SCANNER (MIC)</button>
        </div>
    </div>

    <div id="game-over">
        <h1>CITY DESTROYED</h1>
        <p>Final Score: <span id="final-score">0</span></p>
        <button id="btn-restart" style="border-color:#0f0; color:#0f0; margin-top:10px;">DEPLOY NEW CITY</button>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    import { notes, hzToPitchClass, colorPalettes } from './theory.js';

    const canvas = document.getElementById('c-invaders');
    const ctx = canvas.getContext('2d');
    const audio = new AudioEngine();

    // UI Elements
    const btnMic = document.getElementById('btn-mic');
    const btnRestart = document.getElementById('btn-restart');
    const scoreText = document.getElementById('score-text');
    const statusHealth = document.getElementById('status-health');
    const statusNote = document.getElementById('status-note');
    const gameOverPanel = document.getElementById('game-over');
    const finalScore = document.getElementById('final-score');

    // Game State
    let isGameOver = false;
    let score = 0;
    let health = 100;
    let frames = 0;
    let spawnRate = 120; // Lower is faster
    let enemySpeed = 1;

    // Entities
    let enemies = [];
    let particles = [];
    let laser = null;
    let cannon = { x: 0, y: 0 };

    // Cooldown logic
    let lastPlayedNote = -1;
    let noteHoldFrames = 0; 

    function resize() { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight; 
        cannon.x = canvas.width / 2;
        cannon.y = canvas.height - 40;
    }
    window.addEventListener('resize', resize); resize();

    function resetGame() {
        enemies = [];
        particles = [];
        score = 0;
        health = 100;
        frames = 0;
        spawnRate = 120;
        enemySpeed = 1;
        isGameOver = false;
        gameOverPanel.style.display = 'none';
        scoreText.innerText = score;
        updateHealthUI();
    }

    btnRestart.addEventListener('click', resetGame);

    btnMic.addEventListener('click', async () => {
        const started = await audio.startMic();
        if (started) {
            btnMic.style.display = 'none';
            resetGame();
            renderFrame();
        }
    });

    function spawnEnemy() {
        let noteValue = Math.floor(Math.random() * 12);
        let colorGroup = Math.floor(noteValue / 4);
        let xPos = 40 + Math.random() * (canvas.width - 80); // Keep away from edges
        
        enemies.push({
            x: xPos,
            y: -30,
            note: noteValue,
            color: colorPalettes[colorGroup],
            radius: 25
        });
    }

    function createExplosion(x, y, color) {
        for(let i=0; i<15; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10,
                life: 1.0,
                color: color
            });
        }
    }

    function updateHealthUI() {
        statusHealth.innerText = `CITY INTEGRITY: ${health}%`;
        if(health > 60) statusHealth.style.color = '#00ffcc';
        else if(health > 30) statusHealth.style.color = '#ff8c00';
        else statusHealth.style.color = '#ff0055';
    }

    function renderFrame() {
        if (!audio.isRunning || isGameOver) return;
        requestAnimationFrame(renderFrame);
        
        // Draw trailing background
        ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        frames++;
        laser = null;

        // --- AUDIO PROCESSING ---
        let peaks = audio.getPeaks(95); 
        let currentNote = -1;
        
        if (peaks.length > 0) {
            currentNote = hzToPitchClass(peaks[0].hz);
            statusNote.innerText = `LOCKING: ${notes[currentNote]}`;
        } else {
            statusNote.innerText = `AWAITING SIGNAL...`;
            lastPlayedNote = -1;
        }

        // Firing logic (prevent rapid-fire spam from holding a single note)
        if (currentNote !== -1) {
            if (currentNote !== lastPlayedNote || noteHoldFrames > 30) {
                // Find target
                let targetIdx = -1;
                let lowestY = -999;
                
                // Target the asteroid closest to the ground that matches the note
                for (let i = 0; i < enemies.length; i++) {
                    if (enemies[i].note === currentNote && enemies[i].y > lowestY) {
                        lowestY = enemies[i].y;
                        targetIdx = i;
                    }
                }

                if (targetIdx !== -1) {
                    let target = enemies[targetIdx];
                    laser = { x: target.x, y: target.y, color: target.color };
                    createExplosion(target.x, target.y, target.color);
                    enemies.splice(targetIdx, 1);
                    score += 10;
                    scoreText.innerText = score;
                    
                    // Difficulty scaling
                    if (score % 50 === 0) {
                        enemySpeed += 0.2;
                        spawnRate = Math.max(40, spawnRate - 10);
                    }
                }
                
                lastPlayedNote = currentNote;
                noteHoldFrames = 0;
            } else {
                noteHoldFrames++;
            }
        }

        // --- ENEMY LOGIC ---
        if (frames % spawnRate === 0) spawnEnemy();

        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i];
            e.y += enemySpeed;
            
            // Draw Asteroid Body
            ctx.shadowBlur = 15; ctx.shadowColor = e.color;
            ctx.fillStyle = '#111'; ctx.strokeStyle = e.color; ctx.lineWidth = 2;
            
            // Draw Hexagon for sci-fi feel
            ctx.beginPath();
            for (let j = 0; j < 6; j++) {
                let angle = (Math.PI / 3) * j;
                let hx = e.x + Math.cos(angle) * e.radius;
                let hy = e.y + Math.sin(angle) * e.radius;
                if (j === 0) ctx.moveTo(hx, hy);
                else ctx.lineTo(hx, hy);
            }
            ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.shadowBlur = 0;

            // Draw Note Text
            ctx.fillStyle = '#fff'; ctx.font = 'bold 16px monospace'; 
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(notes[e.note], e.x, e.y);

            // Floor Collision (Damage)
            if (e.y > canvas.height - 50) {
                createExplosion(e.x, e.y, '#ff0000');
                enemies.splice(i, 1);
                health -= 10;
                updateHealthUI();
                
                // Red screen flash
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (health <= 0) {
                    isGameOver = true;
                    finalScore.innerText = score;
                    gameOverPanel.style.display = 'block';
                }
            }
        }

        // --- DRAW PARTICLES ---
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.05;
            
            ctx.globalAlpha = Math.max(0, p.life);
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
            ctx.globalAlpha = 1.0;

            if (p.life <= 0) particles.splice(i, 1);
        }

        // --- DRAW CANNON & LASER ---
        if (laser) {
            ctx.strokeStyle = laser.color;
            ctx.lineWidth = 6;
            ctx.shadowBlur = 20; ctx.shadowColor = laser.color;
            ctx.beginPath();
            ctx.moveTo(cannon.x, cannon.y);
            ctx.lineTo(laser.x, laser.y);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        // Cannon Turret
        ctx.fillStyle = '#333'; ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(cannon.x, cannon.y, 20, Math.PI, 0); ctx.fill(); ctx.stroke();
        ctx.fillRect(cannon.x - 5, cannon.y - 35, 10, 20); // Barrel
    }
</script>
</body>
</html>