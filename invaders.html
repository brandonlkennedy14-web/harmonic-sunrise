<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonic Invaders</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');
        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* Fixed UI Overlap - 110px padding */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 110px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        
        .hud { display: flex; justify-content: space-between; width: 100%; pointer-events: auto; }
        .title { font-size: 20px; font-weight: bold; color: #ff0055; letter-spacing: 2px; }
        .score-display { font-size: 24px; color: #0f0; font-weight: bold; }
        
        .hud-box { background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #333; margin-top: 10px; width: fit-content; }
        .health-text { color: #00ffcc; font-size: 14px; font-weight: bold;}

        .controls { display: flex; gap: 10px; pointer-events: auto; }
        button { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px 15px; font-family: 'Space Mono'; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 20; pointer-events: auto; background: rgba(0,0,0,0.9); padding: 40px; border: 2px solid #ff0055; }
    </style>
</head>
<body>

    <div id="global-nav" style="position: absolute; top: 0; left: 0; width: 100%; z-index: 100; display: flex; justify-content: center; gap: 10px; padding: 15px 5px; background: rgba(0,0,0,0.85); border-bottom: 2px solid #333; pointer-events: auto; font-family: 'Space Mono', monospace; box-sizing: border-box; flex-wrap: wrap; font-size: 12px;">
        <a href="index.html" style="color: #ff8c00; text-decoration: none; font-weight: bold;">[1] SUNRISE</a> <span style="color: #555;">|</span>
        <a href="flappy.html" style="color: #00ffcc; text-decoration: none; font-weight: bold;">[2] FLAPPY</a> <span style="color: #555;">|</span>
        <a href="billiards.html" style="color: #ff00ff; text-decoration: none; font-weight: bold;">[3] WINDING</a> <span style="color: #555;">|</span>
        <a href="invaders.html" style="color: #ff0055; text-decoration: none; font-weight: bold;">[4] INVADERS</a> <span style="color: #555;">|</span>
        <a href="weaver.html" style="color: #b366ff; text-decoration: none; font-weight: bold;">[5] WEAVER</a> <span style="color: #555;">|</span>
        <a href="simon.html" style="color: #fff; text-decoration: none; font-weight: bold;">[6] SIMON</a>
    </div>

    <canvas id="c-invaders"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <div>
                <div class="title">HARMONIC INVADERS</div>
                <div class="hud-box">
                    <div id="status-health" class="health-text">CITY INTEGRITY: 100%</div>
                </div>
            </div>
            <div class="score-display" id="score-text">0</div>
        </div>

        <div class="controls">
            <button id="btn-mic">START SCANNER</button>
        </div>
    </div>

    <div id="game-over">
        <h1 style="color: #ff0055;">CITY DESTROYED</h1>
        <p>Final Score: <span id="final-score">0</span></p>
        <button onclick="location.reload()" style="border-color:#0f0; color:#0f0; margin-top:10px;">REDEPLOY</button>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    import { notes, hzToPitchClass, colorPalettes } from './theory.js';

    const canvas = document.getElementById('c-invaders');
    const ctx = canvas.getContext('2d');
    const audio = new AudioEngine();

    let enemies = [], laser = null, cannon = { x: 0, y: 0 }, health = 100, score = 0, frames = 0;

    function resize() { 
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
        cannon.x = canvas.width / 2;
        cannon.y = canvas.height - 80; // Cannon higher up for mobile visibility
    }
    window.addEventListener('resize', resize); resize();

    document.getElementById('btn-mic').addEventListener('click', async (e) => {
        if (await audio.startMic()) e.target.style.display = 'none';
        render();
    });

    function spawnEnemy() {
        let n = Math.floor(Math.random() * 12);
        enemies.push({
            x: 50 + Math.random() * (canvas.width - 100),
            y: -30,
            note: n,
            color: colorPalettes[Math.floor(n / 4)],
            radius: 25
        });
    }

    function render() {
        requestAnimationFrame(render);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        frames++; laser = null;

        if (audio.isRunning) {
            let peaks = audio.getPeaks(95);
            if (peaks.length > 0) {
                let current = hzToPitchClass(peaks[0].hz);
                let targetIdx = enemies.findIndex(e => e.note === current);
                if (targetIdx !== -1) {
                    let e = enemies[targetIdx];
                    laser = { x: e.x, y: e.y, color: e.color };
                    enemies.splice(targetIdx, 1);
                    score += 10;
                    document.getElementById('score-text').innerText = score;
                }
            }
        }

        if (frames % 120 === 0) spawnEnemy();

        enemies.forEach((e, i) => {
            e.y += 1.5;
            ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x, e.y, e.radius, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.fillText(notes[e.note], e.x, e.y+5);
            
            if (e.y > cannon.y) {
                enemies.splice(i, 1);
                health -= 10;
                document.getElementById('status-health').innerText = `CITY INTEGRITY: ${health}%`;
                if (health <= 0) {
                    document.getElementById('game-over').style.display = 'block';
                    document.getElementById('final-score').innerText = score;
                }
            }
        });

        if (laser) {
            ctx.strokeStyle = laser.color; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(cannon.x, cannon.y); ctx.lineTo(laser.x, laser.y); ctx.stroke();
        }

        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(cannon.x, cannon.y, 20, Math.PI, 0); ctx.fill();
    }
</script>
</body>
</html>