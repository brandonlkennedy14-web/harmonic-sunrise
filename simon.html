<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Simon Sequence</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');

        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 110px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        
        #rules-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); border: 2px solid #fff; padding: 30px; z-index: 100; pointer-events: auto; text-align: center; width: 80%; max-width: 400px; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        
        .hud { display: flex; justify-content: space-between; width: 100%; pointer-events: auto; }
        .title { font-size: 20px; font-weight: bold; color: #fff; letter-spacing: 2px; }
        
        .controls { display: flex; gap: 10px; pointer-events: auto; justify-content: center; width: 100%; }
        button { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px 20px; font-family: 'Space Mono'; cursor: pointer; text-transform: uppercase; font-weight: bold;}
        
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 20; pointer-events: auto; background: rgba(0,0,0,0.95); padding: 40px; border: 2px solid #ff0055; }
    </style>
</head>
<body>

    <div id="global-nav" style="position: absolute; top: 0; left: 0; width: 100%; z-index: 100; display: flex; justify-content: center; gap: 10px; padding: 15px 5px; background: rgba(0,0,0,0.85); border-bottom: 2px solid #333; pointer-events: auto; font-family: 'Space Mono', monospace; box-sizing: border-box; flex-wrap: wrap; font-size: 12px;">
        <a href="index.html" style="color: #ff8c00; text-decoration: none; font-weight: bold;">[1] SUNRISE</a> <span style="color: #555;">|</span>
        <a href="flappy.html" style="color: #00ffcc; text-decoration: none; font-weight: bold;">[2] FLAPPY</a> <span style="color: #555;">|</span>
        <a href="billiards.html" style="color: #ff00ff; text-decoration: none; font-weight: bold;">[3] WINDING</a> <span style="color: #555;">|</span>
        <a href="invaders.html" style="color: #ff0055; text-decoration: none; font-weight: bold;">[4] INVADERS</a> <span style="color: #555;">|</span>
        <a href="weaver.html" style="color: #b366ff; text-decoration: none; font-weight: bold;">[5] WEAVER</a> <span style="color: #555;">|</span>
        <a href="simon.html" style="color: #fff; text-decoration: none; font-weight: bold;">[6] SIMON</a>
    </div>

    <div id="rules-overlay">
        <h2 style="color: #00ffcc;">THE MONOLITH</h2>
        <p style="font-size: 14px; line-height: 1.6;">Watch the sequence of runes illuminated by the monolith. Repeat the sequence back exactly on your instrument.</p>
        <p style="font-size: 12px; color: #ff8c00;">One wrong note and the uplink is lost.</p>
        <button onclick="document.getElementById('rules-overlay').style.display='none'">COMMENCE</button>
    </div>

    <canvas id="c-simon"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <div>
                <div class="title">SIMON SEQUENCE</div>
                <div id="status-text" style="color: #ff8c00; font-size: 12px; margin-top: 5px;">AWAITING UPLINK...</div>
            </div>
            <div id="score-text" style="font-size: 24px; color: #00ffcc;">STAGE: 1</div>
        </div>

        <div class="controls">
            <button id="btn-start">START MIC & UPLINK</button>
        </div>
    </div>

    <div id="game-over">
        <h1 style="color: #ff0055;">UPLINK LOST</h1>
        <p>You reached Stage <span id="final-score">1</span></p>
        <button id="btn-restart" style="border-color:#fff;">RETRY</button>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    import { notes, hzToPitchClass, colorPalettes } from './theory.js';

    const canvas = document.getElementById('c-simon');
    const ctx = canvas.getContext('2d');
    const audio = new AudioEngine();

    let gameState = 'IDLE', sequence = [], playerIndex = 0, score = 1;
    let activeRuneIndex = -1;
    let visualMonolithGlow = 0;
    let visualMonolithColor = '#333';
    let hitCooldown = 0;

    function resize() { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight; 
    }
    window.addEventListener('resize', resize); resize();

    async function playSequence() {
        gameState = 'PLAYING';
        document.getElementById('status-text').innerText = "MONOLITH TRANSMITTING...";
        document.getElementById('status-text').style.color = "#00ffcc";
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        for (let i = 0; i < sequence.length; i++) {
            let noteIdx = sequence[i];
            
            // Visual trigger ONLY (No audio)
            visualMonolithColor = colorPalettes[Math.floor(noteIdx / 4)];
            visualMonolithGlow = 1.0;
            activeRuneIndex = noteIdx;
            
            await new Promise(resolve => setTimeout(resolve, 600)); // Hold light
            
            activeRuneIndex = -1;
            
            await new Promise(resolve => setTimeout(resolve, 300)); // Dark gap between notes
        }
        
        gameState = 'LISTENING';
        document.getElementById('status-text').innerText = "YOUR TURN: REPEAT SEQUENCE";
        document.getElementById('status-text').style.color = "#ff8c00";
        visualMonolithColor = '#333';
    }

    function addNoteToSequence() {
        sequence.push(Math.floor(Math.random() * 12));
        playSequence();
    }

    document.getElementById('btn-start').addEventListener('click', async (e) => {
        if (await audio.startMic()) {
            e.target.style.display = 'none';
            sequence = []; score = 1; addNoteToSequence();
            renderFrame();
        }
    });

    document.getElementById('btn-restart').addEventListener('click', () => {
        document.getElementById('game-over').style.display = 'none';
        sequence = []; score = 1; document.getElementById('score-text').innerText = "STAGE: 1";
        addNoteToSequence();
    });

    function triggerSuccess() {
        gameState = 'SUCCESS';
        document.getElementById('status-text').innerText = "PATTERN ACCEPTED.";
        document.getElementById('status-text').style.color = "#0f0";
        visualMonolithColor = '#0f0';
        visualMonolithGlow = 1.0;
        score++;
        document.getElementById('score-text').innerText = `STAGE: ${score}`;
        
        setTimeout(() => { addNoteToSequence(); }, 1500);
    }

    function renderFrame() {
        requestAnimationFrame(renderFrame);
        
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let cx = canvas.width / 2;
        let cy = canvas.height / 2;

        if (hitCooldown > 0) hitCooldown--;

        if (gameState === 'LISTENING' && hitCooldown === 0) {
            let peaks = audio.getPeaks(100);
            if (peaks.length > 0) {
                let playedNoteIdx = hzToPitchClass(peaks[0].hz);
                
                if (playedNoteIdx !== -1) {
                    let expectedNoteIdx = sequence[playerIndex];
                    
                    visualMonolithColor = colorPalettes[Math.floor(playedNoteIdx / 4)];
                    visualMonolithGlow = 0.8;
                    activeRuneIndex = playedNoteIdx;
                    
                    if (playedNoteIdx === expectedNoteIdx) {
                        playerIndex++;
                        hitCooldown = 45; 
                        
                        setTimeout(() => { activeRuneIndex = -1; }, 400);

                        if (playerIndex >= sequence.length) {
                            playerIndex = 0;
                            triggerSuccess();
                        }
                    } else {
                        gameState = 'GAMEOVER';
                        document.getElementById('status-text').innerText = "PATTERN REJECTED.";
                        document.getElementById('status-text').style.color = "#ff0055";
                        visualMonolithColor = '#ff0055';
                        visualMonolithGlow = 1.0;
                        document.getElementById('final-score').innerText = score;
                        setTimeout(() => { document.getElementById('game-over').style.display = 'block'; }, 1000);
                    }
                }
            }
        }

        visualMonolithGlow = Math.max(0, visualMonolithGlow - 0.02);
        let radius = Math.min(canvas.width, canvas.height) * 0.35;
        
        ctx.lineWidth = 2;
        for (let i = 0; i < 12; i++) {
            let angle = (i * Math.PI / 6) - (Math.PI / 2);
            let rx = cx + Math.cos(angle) * radius;
            let ry = cy + Math.sin(angle) * radius;
            
            if (i === activeRuneIndex) {
                ctx.fillStyle = visualMonolithColor;
                ctx.shadowBlur = 20; ctx.shadowColor = visualMonolithColor;
            } else {
                ctx.fillStyle = '#222';
                ctx.shadowBlur = 0;
            }
            
            ctx.beginPath();
            ctx.moveTo(rx, ry - 10); ctx.lineTo(rx + 10, ry);
            ctx.lineTo(rx, ry + 10); ctx.lineTo(rx - 10, ry);
            ctx.closePath(); ctx.fill();
            
            ctx.fillStyle = (i === activeRuneIndex) ? '#fff' : '#444';
            ctx.font = '12px monospace'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(notes[i], cx + Math.cos(angle) * (radius + 25), cy + Math.sin(angle) * (radius + 25));
        }

        // Draw Crystal Monolith
        ctx.shadowBlur = visualMonolithGlow * 50;
        ctx.shadowColor = visualMonolithColor;
        let mWidth = 60, mHeight = 180;
        
        ctx.fillStyle = visualMonolithGlow > 0.1 ? visualMonolithColor : '#111';
        ctx.strokeStyle = visualMonolithColor;
        
        ctx.beginPath();
        ctx.moveTo(cx, cy - mHeight/2 - 30); 
        ctx.lineTo(cx + mWidth/2, cy - mHeight/2); 
        ctx.lineTo(cx + mWidth/2, cy + mHeight/2); 
        ctx.lineTo(cx, cy + mHeight/2 + 30); 
        ctx.lineTo(cx - mWidth/2, cy + mHeight/2); 
        ctx.lineTo(cx - mWidth/2, cy - mHeight/2); 
        ctx.closePath();
        ctx.fill();
        if (visualMonolithGlow > 0) ctx.stroke();
        ctx.shadowBlur = 0;

        if (visualMonolithGlow > 0.1) {
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(cx, cy - mHeight/2 - 20); ctx.lineTo(cx, cy + mHeight/2 + 20); ctx.stroke();
        }
    }
</script>
</body>
</html>