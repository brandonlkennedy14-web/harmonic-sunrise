<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Simon Sequence</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');

        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }

        /* Fixed UI Overlap */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 110px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        
        #rules-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); border: 2px solid #fff; padding: 30px; z-index: 100; pointer-events: auto; text-align: center; width: 80%; max-width: 400px; box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        
        .hud { display: flex; justify-content: space-between; width: 100%; pointer-events: auto; }
        .title { font-size: 20px; font-weight: bold; color: #fff; letter-spacing: 2px; }
        
        .controls { display: flex; gap: 10px; pointer-events: auto; justify-content: center; width: 100%; }
        button { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px 20px; font-family: 'Space Mono'; cursor: pointer; text-transform: uppercase; font-weight: bold;}
        
        #game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 20; pointer-events: auto; background: rgba(0,0,0,0.95); padding: 40px; border: 2px solid #ff0055; }
    </style>
</head>
<body>

    <div id="global-nav" style="position: absolute; top: 0; left: 0; width: 100%; z-index: 100; display: flex; justify-content: center; gap: 10px; padding: 15px 5px; background: rgba(0,0,0,0.85); border-bottom: 2px solid #333; pointer-events: auto; font-family: 'Space Mono', monospace; box-sizing: border-box; flex-wrap: wrap; font-size: 12px;">
        <a href="index.html" style="color: #ff8c00; text-decoration: none; font-weight: bold;">[1] SUNRISE</a> <span style="color: #555;">|</span>
        <a href="flappy.html" style="color: #00ffcc; text-decoration: none; font-weight: bold;">[2] FLAPPY</a> <span style="color: #555;">|</span>
        <a href="billiards.html" style="color: #ff00ff; text-decoration: none; font-weight: bold;">[3] WINDING</a> <span style="color: #555;">|</span>
        <a href="invaders.html" style="color: #ff0055; text-decoration: none; font-weight: bold;">[4] INVADERS</a> <span style="color: #555;">|</span>
        <a href="weaver.html" style="color: #b366ff; text-decoration: none; font-weight: bold;">[5] WEAVER</a> <span style="color: #555;">|</span>
        <a href="simon.html" style="color: #fff; text-decoration: none; font-weight: bold;">[6] SIMON</a>
    </div>

    <div id="rules-overlay">
        <h2 style="color: #00ffcc;">THE MONOLITH</h2>
        <p style="font-size: 14px; line-height: 1.6;">Listen to the sequence played by the monolith. Repeat the notes back exactly on your instrument.</p>
        <p style="font-size: 12px; color: #ff8c00;">One wrong note and the uplink is lost.</p>
        <button onclick="document.getElementById('rules-overlay').style.display='none'">COMMENCE</button>
    </div>

    <canvas id="c-simon"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <div>
                <div class="title">SIMON SEQUENCE</div>
                <div id="status-text" style="color: #ff8c00; font-size: 12px; margin-top: 5px;">AWAITING UPLINK...</div>
            </div>
            <div id="score-text" style="font-size: 24px; color: #00ffcc;">STAGE: 1</div>
        </div>

        <div class="controls">
            <button id="btn-start">START MIC & UPLINK</button>
        </div>
    </div>

    <div id="game-over">
        <h1 style="color: #ff0055;">UPLINK LOST</h1>
        <p>You reached Stage <span id="final-score">1</span></p>
        <button id="btn-restart" style="border-color:#fff;">RETRY</button>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    import { notes, hzToPitchClass, colorPalettes } from './theory.js';

    const canvas = document.getElementById('c-simon');
    const ctx = canvas.getContext('2d');
    const audio = new AudioEngine();
    const synthCtx = new (window.AudioContext || window.webkitAudioContext)();

    let gameState = 'IDLE', sequence = [], playerIndex = 0, score = 1, activeRune = -1;

    function playSynthNote(noteIdx, duration) {
        const osc = synthCtx.createOscillator();
        const gain = synthCtx.createGain();
        osc.frequency.value = 261.63 * Math.pow(2, noteIdx/12);
        osc.connect(gain); gain.connect(synthCtx.destination);
        gain.gain.setTargetAtTime(0.5, synthCtx.currentTime, 0.05);
        osc.start(); activeRune = noteIdx;
        osc.stop(synthCtx.currentTime + duration/1000);
        setTimeout(() => { if(activeRune === noteIdx) activeRune = -1; }, duration);
    }

    async function playSequence() {
        gameState = 'PLAYING';
        document.getElementById('status-text').innerText = "MONOLITH SPEAKING...";
        for (let note of sequence) {
            playSynthNote(note, 600);
            await new Promise(r => setTimeout(r, 800));
        }
        gameState = 'LISTENING';
        document.getElementById('status-text').innerText = "YOUR TURN...";
    }

    function addStep() {
        sequence.push(Math.floor(Math.random() * 12));
        playSequence();
    }

    document.getElementById('btn-start').addEventListener('click', async (e) => {
        if (await audio.startMic()) {
            if (synthCtx.state === 'suspended') synthCtx.resume();
            e.target.style.display = 'none';
            sequence = []; score = 1; addStep();
            render();
        }
    });

    document.getElementById('btn-restart').addEventListener('click', () => {
        document.getElementById('game-over').style.display = 'none';
        sequence = []; score = 1; document.getElementById('score-text').innerText = "STAGE: 1";
        addStep();
    });

    function render() {
        requestAnimationFrame(render);
        ctx.fillStyle = '#050505'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        let cx = canvas.width/2, cy = canvas.height/2;

        // Draw Runes
        for (let i = 0; i < 12; i++) {
            let ang = (i * Math.PI/6) - Math.PI/2;
            let rx = cx + Math.cos(ang) * 120, ry = cy + Math.sin(ang) * 120;
            ctx.fillStyle = (i === activeRune) ? '#fff' : '#222';
            ctx.beginPath(); ctx.arc(rx, ry, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = (i === activeRune) ? '#000' : '#444';
            ctx.textAlign = 'center'; ctx.fillText(notes[i], rx, ry+5);
        }

        if (gameState === 'LISTENING') {
            let peaks = audio.getPeaks(100);
            if (peaks.length > 0) {
                let note = hzToPitchClass(peaks[0].hz);
                if (note !== -1) {
                    if (note === sequence[playerIndex]) {
                        playerIndex++;
                        if (playerIndex >= sequence.length) {
                            playerIndex = 0; score++;
                            document.getElementById('score-text').innerText = `STAGE: ${score}`;
                            setTimeout(addStep, 1000);
                        }
                    } else {
                        gameState = 'GAMEOVER';
                        document.getElementById('final-score').innerText = score;
                        document.getElementById('game-over').style.display = 'block';
                    }
                }
            }
        }
    }
</script>
</body>
</html>