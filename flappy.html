<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Fifths</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');
        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 110px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        #rules-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); border: 2px solid #00ffcc; padding: 20px; z-index: 100; pointer-events: auto; text-align: center; }
        .controls { display: flex; gap: 10px; pointer-events: auto; }
        button { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px; cursor: pointer; font-family: 'Space Mono'; }
    </style>
</head>
<body>
    <div id="rules-overlay">
        <h3>FLAPPY FIFTHS RULES</h3>
        <p style="font-size: 12px; color: #aaa;">EASY: Snap to note lanes.<br>HARD: Play a Perfect 5th to flap!</p>
        <button onclick="document.getElementById('rules-overlay').style.display='none'">START</button>
    </div>

    <canvas id="c-flappy"></canvas>
    <div id="ui-layer">
        <div style="display:flex; justify-content: space-between; pointer-events: auto;">
            <div id="status-note" style="color:#00ffcc;">PLAY A NOTE...</div>
            <div id="score-text" style="font-size: 24px;">0</div>
        </div>
        <div class="controls">
            <button id="btn-mic">START MIC</button>
            <button id="btn-mode">MODE: EASY</button>
        </div>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    import { notes, hzToPitchClass, circleOfFifths } from './theory.js';

    const audio = new AudioEngine();
    const canvas = document.getElementById('c-flappy');
    const ctx = canvas.getContext('2d');

    let mode = 'EASY', bird = { x: 100, y: 300, radius: 18, vel: 0 }, targetNote = -1, lastNote = -1;

    document.getElementById('btn-mic').addEventListener('click', async (e) => {
        if (await audio.startMic()) e.target.style.display = 'none';
    });

    document.getElementById('btn-mode').addEventListener('click', (e) => {
        mode = mode === 'EASY' ? 'HARD' : 'EASY';
        e.target.innerText = `MODE: ${mode}`;
    });

    function drawCircleHUD(current) {
        let cx = 80, cy = canvas.height - 180, r = 50;
        ctx.strokeStyle = '#333'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.stroke();
        circleOfFifths.forEach((n, i) => {
            let ang = (i * Math.PI/6) - Math.PI/2;
            ctx.fillStyle = (n === current) ? '#0f0' : (n === targetNote) ? '#ff8c00' : '#555';
            ctx.fillText(notes[n], cx + Math.cos(ang)*r, cy + Math.sin(ang)*r);
        });
        if (current !== -1 && targetNote !== -1) {
            ctx.strokeStyle = '#ff8c00'; ctx.beginPath(); ctx.moveTo(cx, cy);
            let tAng = (circleOfFifths.indexOf(targetNote) * Math.PI/6) - Math.PI/2;
            ctx.lineTo(cx + Math.cos(tAng)*r, cy + Math.sin(tAng)*r); ctx.stroke();
        }
    }

    function render() {
        requestAnimationFrame(render);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let current = -1;
        if (audio.isRunning) {
            let peaks = audio.getPeaks(100);
            if (peaks.length > 0) current = hzToPitchClass(peaks[0].hz);
        }

        if (mode === 'HARD') {
            bird.vel += 0.4; bird.y += bird.vel;
            if (current !== -1 && current !== lastNote) {
                if (lastNote === -1 || current === targetNote) {
                    bird.vel = -8; lastNote = current; targetNote = (current + 7) % 12;
                }
            }
            drawCircleHUD(current);
        } else if (current !== -1) {
            let targetY = canvas.height - ((current / 11) * (canvas.height - 100)) - 50;
            bird.y += (targetY - bird.y) * 0.15;
        }

        ctx.fillStyle = '#00ffcc'; ctx.beginPath(); ctx.arc(bird.x, bird.y, bird.radius, 0, Math.PI*2); ctx.fill();
        if (current !== -1) { ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.fillText(notes[current], bird.x, bird.y+5); }
    }
    render();
</script>
</body>
</html>