<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Harmonic Sunrise</title>
<link rel="apple-touch-icon" href="icon-192.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
:root{--g:#00ff41;--d:#00661a;--bg:#000300;--p:#010a01;--glow:0 0 8px #00ff41,0 0 20px rgba(0,255,65,.5);--f:'VT323','Courier New',monospace}
*{box-sizing:border-box;font-family:var(--f)!important;letter-spacing:1px!important}
body{margin:0;padding:0;background:var(--bg)!important;color:var(--g)!important;overflow:hidden;touch-action:manipulation}
canvas{display:block;width:100vw;height:100vh;position:absolute;top:0;left:0;image-rendering:pixelated}
#c-stars{z-index:1}#c-ruliad{z-index:2}#c-main{z-index:3;background:transparent}#c-munker{z-index:4;pointer-events:none}
#ui{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;display:flex;flex-direction:column;justify-content:space-between;padding:100px 14px 14px;pointer-events:none}
.hud{display:flex;justify-content:space-between;width:100%;pointer-events:auto}
.title{font-size:22px;color:var(--g)!important;text-shadow:var(--glow)!important;letter-spacing:4px!important}
.sub{color:#00cc33!important;font-size:12px;margin-top:3px}
.rb{padding:3px 8px;border-left:3px solid var(--g);margin-bottom:3px;background:var(--p);color:var(--g)!important;text-shadow:var(--glow)!important;font-size:13px;transition:border-color .3s}
.sc{font-size:34px;color:var(--g)!important;text-shadow:var(--glow)!important;text-align:right}
.ctrls{display:flex;pointer-events:auto;margin-bottom:12px;flex-wrap:wrap;gap:7px}
btn,button{background:var(--p)!important;border:1px solid var(--g)!important;color:var(--g)!important;text-shadow:var(--glow)!important;padding:8px 13px;font-size:14px;cursor:pointer;text-transform:uppercase;letter-spacing:2px!important;border-radius:0!important}
#hard-cfg{background:var(--p);border:1px solid var(--d);padding:8px 12px;margin-top:5px;display:none;font-size:13px}
#hard-cfg label{color:#00cc33!important;min-width:55px;display:inline-block;font-size:11px}
#hard-cfg input,#hard-cfg select{background:#000!important;border:1px solid var(--g)!important;color:var(--g)!important;width:52px;padding:1px 3px;font-size:13px;font-family:var(--f)!important}
#go{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;display:none;z-index:20;pointer-events:auto;background:#000500!important;padding:32px 44px;border:1px solid var(--g)!important;box-shadow:0 0 40px rgba(0,255,65,.25)}
#go h1{color:var(--g)!important;text-shadow:var(--glow)!important;margin:0 0 8px;font-size:26px;letter-spacing:4px}
#go p{color:#00cc33!important;font-size:15px}
#pa{position:absolute;top:0;left:0;width:100%;height:3px;z-index:15;pointer-events:none;transition:background .5s;opacity:.7}
#nav{position:absolute;top:0;left:0;width:100%;z-index:100;display:flex;justify-content:center;gap:8px;padding:11px 4px;background:rgba(0,3,0,.95);border-bottom:1px solid #003311;pointer-events:auto;box-sizing:border-box;flex-wrap:wrap;font-size:12px}
#nav a{color:var(--g)!important;text-decoration:none;text-shadow:var(--glow)!important}#nav span{color:#003311}
</style>
</head>
<body>
<div id="nav">
<a href="index.html">[1]SUNRISE</a><span>|</span><a href="flappy.html">[2]FLAPPY</a><span>|</span><a href="billiards.html">[3]WINDING</a><span>|</span><a href="invaders.html">[4]INVADERS</a><span>|</span><a href="weaver.html">[5]WEAVER</a><span>|</span><a href="simon.html">[6]SIMON</a>
</div>
<div id="pa"></div>
<canvas id="c-stars"></canvas><canvas id="c-ruliad"></canvas><canvas id="c-main"></canvas><canvas id="c-munker"></canvas>
<div id="ui">
  <div class="hud">
    <div>
      <div class="title">HARMONIC SUNRISE</div>
      <div class="sub" id="st">AWAITING AUDIO…</div>
      <div style="margin-top:8px">
        <div class="rb" id="hn">NOTE: --</div>
        <div class="rb" id="hr">P5 RISE → --</div>
        <div class="rb" id="hd">P4/TT DIVE → --</div>
        <div class="rb" id="hv">SPD: -- | VEL: --</div>
        <div class="rb" id="hb" style="display:none">BEAT: --</div>
      </div>
      <div id="hard-cfg">
        <div style="color:var(--g);margin-bottom:5px;font-size:13px">── HARD MODE ──</div>
        <label>BPM</label><input type="number" id="ibpm" value="120" min="40" max="240">&nbsp;
        <label>METER</label><select id="imeter"><option value="4">4/4</option><option value="3">3/4</option><option value="5">5/4</option></select>&nbsp;
        <label>SWING%</label><input type="number" id="iswing" value="50" min="50" max="75" step="5">
      </div>
    </div>
    <div>
      <div class="sub" style="text-align:right">BEST: <span id="hs">0</span></div>
      <div class="sub" style="text-align:right;margin-top:5px">DAYS</div>
      <div class="sc" id="sc">0</div>
    </div>
  </div>
  <div class="ctrls">
    <button id="bmic">START MIC</button>
    <button id="bhard">HARD: OFF</button>
  </div>
</div>
<div id="go">
  <h1 id="gr">CRASHED!</h1>
  <p>Days: <span id="gf" style="font-size:20px;color:var(--g)!important">0</span></p>
  <p id="ghp" style="display:none"></p>
  <button id="brst" style="margin-top:14px">RELAUNCH</button>
</div>
<script>
// ── CONSTANTS ────────────────────────────────────────────────────────────────
const NOTE=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const HUE=[0,30,55,80,110,145,175,200,230,265,295,330];
function pc(hz){if(hz<=0)return -1;let h=Math.round(12*Math.log2(hz/16.35));return((h%12)+12)%12}
function lh(a,b,t){let d=b-a;if(d>180)d-=360;if(d<-180)d+=360;return(a+d*t+360)%360}

// ── AUDIO ────────────────────────────────────────────────────────────────────
class Mic{
  constructor(){this.ctx=null;this.an=null;this.isRunning=false;this.buf=null}
  async start(){
    try{
      this.ctx=new(window.AudioContext||window.webkitAudioContext)();
      const s=await navigator.mediaDevices.getUserMedia({audio:true});
      const src=this.ctx.createMediaStreamSource(s);
      this.an=this.ctx.createAnalyser();
      this.an.fftSize=8192;this.an.smoothingTimeConstant=0.82;
      src.connect(this.an);this.buf=new Uint8Array(this.an.frequencyBinCount);
      this.isRunning=true;return true;
    }catch(e){return false}
  }
  // Returns pitch class or -1. High threshold + requires 80-2000 Hz.
  read(thr=110){
    if(!this.isRunning)return -1;
    this.an.getByteFrequencyData(this.buf);
    const bHz=this.ctx.sampleRate/this.an.fftSize;
    const lo=Math.floor(80/bHz),hi=Math.min(Math.floor(2000/bHz),this.buf.length-1);
    let mx=0,mi=-1;
    for(let i=lo;i<=hi;i++)if(this.buf[i]>mx){mx=this.buf[i];mi=i}
    return mx>thr?pc(mi*bHz):-1;
  }
}
const mic=new Mic();

// ── CANVAS ───────────────────────────────────────────────────────────────────
const cS=document.getElementById('c-stars'),xS=cS.getContext('2d');
const cR=document.getElementById('c-ruliad'),xR=cR.getContext('2d');
const cG=document.getElementById('c-main'),ctx=cG.getContext('2d');
const cM=document.getElementById('c-munker'),xM=cM.getContext('2d');
let W,H,cx,cy;

// ── STATE ─────────────────────────────────────────────────────────────────────
let state='IDLE',days=0,frames=0;
let hi=0;try{hi=parseInt(localStorage.getItem('sunriseHi')||'0')}catch(e){}
document.getElementById('hs').innerText=hi;

// note gate: require NOTE_HOLD frames stable before commit
let lastNote=-1,cand=-1,candF=0,silF=0;
const NOTE_HOLD=4,SIL_RST=30;
let tRise=-1,tDive1=-1,tDive2=-1;
let consecutiveP5=0; // track power chord (two P5s in a row = velocity burst)

// physics
const ER=30,SR=18;
let oR=150,rV=0,oA=0,oSpd=0.0045,grav=0.004;
const G0=0.004,DAMP=0.995,TUP=2.8,TDOWN=2.8,MHIT=5;
const VGAIN=0.001,VLOSE=0.0007,VMAX=0.016,VMIN=0.002;
let minR,maxR,sX=0,sY=0;

// hard mode
let hard=false,bpm=120,meter=4;
let bi=0,bt=0,bwin=0,bcount=0,bstreak=0,bhp=0,bflash=0;
function setBeat(){bpm=+document.getElementById('ibpm').value||120;meter=+document.getElementById('imeter').value||4;bi=Math.round(60/bpm*60);bwin=Math.max(5,Math.round(bi*.18));bt=0;bcount=0;bstreak=0;bhp=0}

// wave grid
const CL=14;let gC,gR,w1,w2;
// ruliad
const RC=10;let rCl,rNx,rco,rro;
// visuals
let stars=[],meteors=[],ripples=[];
let mh1=0,mh2=200,mt1=0,mt2=200,sHue=0;

// ── RESIZE ───────────────────────────────────────────────────────────────────
function resize(){
  W=window.innerWidth;H=window.innerHeight;
  [cS,cR,cG,cM].forEach(c=>{c.width=W;c.height=H});
  cx=W/2;cy=H/2;minR=ER+SR+8;maxR=Math.min(W,H)/2-30;
  if(oR<minR)oR=(minR+maxR)/2;
  gC=Math.ceil(W/CL)+1;gR=Math.ceil(H/CL)+1;w1=new Float32Array(gC*gR);w2=new Float32Array(gC*gR);
  rco=Math.ceil(W/RC)+1;rro=Math.ceil(H/RC)+1;
  rCl=new Uint8Array(rco*rro);rNx=new Uint8Array(rco*rro);
  for(let i=0;i<rCl.length;i++)rCl[i]=Math.random()<.35?1:0;
  stars=[];for(let i=0;i<280;i++)stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()<.15?2:1,b:.2+Math.random()*.8,tw:Math.random()*Math.PI*2});
}
window.addEventListener('resize',resize);

// ── STARFIELD ────────────────────────────────────────────────────────────────
function drawStars(p){
  xS.fillStyle='#000';xS.fillRect(0,0,W,H);
  stars.forEach(s=>{const tw=.6+.4*Math.sin(s.tw+frames*.02);xS.fillStyle=p>=0?`hsla(${HUE[p]},60%,80%,${s.b*tw*.9})`:`rgba(255,255,255,${s.b*tw*.9})`;xS.fillRect(s.x,s.y,s.r,s.r)});
}

// ── RULIAD ───────────────────────────────────────────────────────────────────
function stepRuliad(){
  for(let y=0;y<rro;y++)for(let x=0;x<rco;x++){
    const i=y*rco+x;let n=0;
    for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){if(!dx&&!dy)continue;n+=rCl[((y+dy+rro)%rro)*rco+(x+dx+rco)%rco]}
    const a=rCl[i];rNx[i]=a?((n===2||n===3)?1:0):((n===3||n===6)?1:0);
  }
  let t=rCl;rCl=rNx;rNx=t;
}
function drawRuliad(p){
  xR.clearRect(0,0,W,H);const h=p>=0?HUE[p]:180;
  for(let y=0;y<rro;y++)for(let x=0;x<rco;x++){if(rCl[y*rco+x]){xR.fillStyle=`hsla(${h},70%,55%,.18)`;xR.fillRect(x*RC,y*RC,RC-1,RC-1)}}
}

// ── MUNKER ───────────────────────────────────────────────────────────────────
function drawMunker(h1,h2,op){
  xM.clearRect(0,0,W,H);const S=16;
  for(let y=0;y<H;y++){const m=y%S;
    if(m<2){xM.fillStyle=`hsla(${h1},100%,58%,${op})`;xM.fillRect(0,y,W,1)}
    else if(m>=S/2&&m<S/2+2){xM.fillStyle=`hsla(${h2},100%,58%,${op})`;xM.fillRect(0,y,W,1)}
    else if(m===3||m===S/2-1){xM.fillStyle='rgba(0,0,0,.6)';xM.fillRect(0,y,W,1)}
  }
}

// ── WAVES ────────────────────────────────────────────────────────────────────
function stepWave(){
  for(let y=1;y<gR-1;y++)for(let x=1;x<gC-1;x++){
    const i=x+y*gC;if(Math.hypot(x*CL-cx,y*CL-cy)<ER){w2[i]=0;continue}
    w2[i]=(w1[i-1]+w1[i+1]+w1[i-gC]+w1[i+gC])/2-w2[i];w2[i]*=.97;
  }
  let t=w1;w1=w2;w2=t;
}
function splash(wx,wy,e){
  const bx=Math.floor(wx/CL),by=Math.floor(wy/CL);
  for(let dy=-3;dy<=3;dy++)for(let dx=-3;dx<=3;dx++){const px=bx+dx,py=by+dy;if(px>0&&px<gC-1&&py>0&&py<gR-1)w1[py*gC+px]=e*(1-Math.hypot(dx,dy)/5)}
}
function drawWave(){
  stepWave();const wh=lastNote>=0?HUE[lastNote]:200;
  for(let y=0;y<gR;y++)for(let x=0;x<gC;x++){const v=w1[x+y*gC];if(Math.abs(v)>1.5){ctx.fillStyle=`hsla(${wh},90%,65%,${Math.min(1,Math.abs(v)/35)*.75})`;ctx.fillRect(x*CL,y*CL,CL,CL)}}
}

// ── RIPPLES ──────────────────────────────────────────────────────────────────
function ripple(x,y,hue){ripples.push({x,y,r:SR,maxR:SR*6,hue,a:.8})}
function drawRipples(){
  for(let i=ripples.length-1;i>=0;i--){const r=ripples[i];r.r+=3.5;r.a-=.022;if(r.a<=0||r.r>r.maxR){ripples.splice(i,1);continue}
    ctx.strokeStyle=`hsla(${r.hue},100%,65%,${r.a})`;ctx.lineWidth=2;ctx.beginPath();ctx.arc(r.x,r.y,r.r,0,Math.PI*2);ctx.stroke()}
}

// ── PLANET ───────────────────────────────────────────────────────────────────
function planet(c,x,y,r,base,hi,px=4){
  for(let py=-r;py<=r;py+=px)for(let ppx=-r;ppx<=r;ppx+=px){if(ppx*ppx+py*py<=r*r){c.fillStyle=(ppx<0&&py<0)?hi:base;c.fillRect(Math.round(x+ppx),Math.round(y+py),px,px)}}
}

// ── TRAJECTORY PREVIEW ───────────────────────────────────────────────────────
function drawTrajectory(){
  if(state!=='ORBITING'||lastNote<0)return;
  let sr=oR,sv=rV,sa=oA;
  ctx.save();ctx.setLineDash([4,7]);ctx.lineWidth=1.5;
  let px=sX,py=sY;
  for(let i=0;i<40;i++){
    sv-=grav;sv*=DAMP;sr+=sv;sa+=oSpd;
    const tx=cx+Math.cos(sa)*sr,ty=cy+Math.sin(sa)*sr;
    const alpha=(1-i/40)*.5;
    ctx.strokeStyle=`hsla(${sHue},100%,65%,${alpha})`;
    ctx.beginPath();ctx.moveTo(px,py);ctx.lineTo(tx,ty);ctx.stroke();
    px=tx;py=ty;
  }
  ctx.setLineDash([]);ctx.restore();
  // note hint labels near sun
  if(tRise>=0){
    ctx.save();ctx.font='bold 13px VT323,monospace';ctx.textBaseline='middle';
    ctx.fillStyle=`hsl(${HUE[tRise]},100%,65%)`;ctx.shadowBlur=6;ctx.shadowColor=ctx.fillStyle;
    ctx.textAlign='left';ctx.fillText(`P5↑ ${NOTE[tRise]}`,sX+SR+6,sY-12);
    ctx.fillStyle=`hsl(${HUE[tDive1]},100%,65%)`;ctx.shadowColor=ctx.fillStyle;
    ctx.fillText(`P4↓ ${NOTE[tDive1]}`,sX+SR+6,sY+4);
    ctx.restore();
  }
}

// ── BEAT METER ───────────────────────────────────────────────────────────────
function drawBeat(){
  if(!hard)return;
  const bw=26,gap=4,sx=cx-(meter*(bw+gap))/2;
  for(let i=0;i<meter;i++){ctx.fillStyle=i===bcount%meter?`hsl(${sHue},100%,65%)`:'rgba(0,255,65,.12)';ctx.fillRect(sx+i*(bw+gap),cy+maxR+16,bw,8)}
  if(bflash>0){ctx.fillStyle=`rgba(0,255,65,${bflash/20*.25})`;ctx.fillRect(0,0,W,H);bflash--}
}

// ── METEORS ──────────────────────────────────────────────────────────────────
function spawnMeteor(){
  const a=Math.random()*Math.PI*2,d=maxR+120,mx=cx+Math.cos(a)*d,my=cy+Math.sin(a)*d;
  const aim=a+Math.PI+(Math.random()-.5)*.8,spd=1.2+Math.random()*1.5;
  meteors.push({x:mx,y:my,vx:Math.cos(aim)*spd,vy:Math.sin(aim)*spd,sz:(Math.floor(Math.random()*3)+1)*4+6,tr:[]});
}
function drawMeteors(){
  for(let i=meteors.length-1;i>=0;i--){
    const m=meteors[i];m.tr.unshift({x:m.x,y:m.y});if(m.tr.length>10)m.tr.pop();
    m.x+=m.vx;m.y+=m.vy;
    m.tr.forEach((pt,ti)=>{const a=(1-ti/m.tr.length)*.7;ctx.fillStyle=`rgba(200,200,200,${a})`;const s=Math.max(1,m.sz*.3*(1-ti/m.tr.length));ctx.fillRect(pt.x,pt.y,s,s)});
    planet(ctx,m.x,m.y,m.sz,'#b0b0b0','#e0e0e0',3);
    if(state==='ORBITING'&&Math.hypot(m.x-sX,m.y-sY)<SR+m.sz){rV-=MHIT;splash(sX,sY,500);meteors.splice(i,1);continue}
    if(Math.hypot(m.x-cx,m.y-cy)>maxR+400)meteors.splice(i,1);
  }
}

// ── GAME OVER / RESET ────────────────────────────────────────────────────────
function die(reason){
  state='DEAD';
  if(days>hi){hi=days;try{localStorage.setItem('sunriseHi',hi)}catch(e){}document.getElementById('hs').innerText=hi}
  document.getElementById('gr').innerText=reason;
  document.getElementById('gf').innerText=days;
  const ghp=document.getElementById('ghp');
  if(hard){ghp.style.display='block';ghp.innerText=`BEAT PTS: ${bhp} | STREAK: ${bstreak}`}else ghp.style.display='none';
  document.getElementById('go').style.display='block';
}
function reset(){
  oR=(minR+maxR)/2;rV=0;oA=0;grav=G0;oSpd=0.0045;days=0;frames=0;
  lastNote=-1;cand=-1;candF=0;silF=0;tRise=-1;tDive1=-1;tDive2=-1;consecutiveP5=0;
  state='IDLE';
  document.getElementById('go').style.display='none';
  document.getElementById('sc').innerText='0';
  document.getElementById('st').innerText='PLAY A NOTE TO START';
  w1.fill(0);w2.fill(0);meteors=[];ripples=[];sHue=0;mh1=0;mh2=200;mt1=0;mt2=200;
  if(hard)setBeat();
}
document.getElementById('brst').addEventListener('click',reset);
document.getElementById('bmic').addEventListener('click',async()=>{if(await mic.start()){document.getElementById('bmic').style.display='none';reset()}});
document.getElementById('bhard').addEventListener('click',()=>{
  hard=!hard;document.getElementById('bhard').innerText=`HARD: ${hard?'ON':'OFF'}`;
  document.getElementById('hard-cfg').style.display=hard?'block':'none';
  document.getElementById('hb').style.display=hard?'block':'none';
  if(hard)setBeat();
});

// ── ON NEW NOTE COMMITTED ────────────────────────────────────────────────────
function onNote(note){
  if(state==='IDLE'){state='ORBITING';document.getElementById('st').innerText='MAINTAIN HABITABLE ORBIT'}
  else if(lastNote>=0){
    const diff=(note-lastNote+12)%12;
    if(diff===7){
      rV+=TUP;
      consecutiveP5++;
      if(consecutiveP5>=2){oSpd=Math.min(VMAX,oSpd+VGAIN*2);consecutiveP5=0} // power chord = two P5s = velocity burst
      else oSpd=Math.min(VMAX,oSpd+VGAIN);
    } else if(diff===6){
      rV-=TDOWN;oSpd=Math.max(VMIN,oSpd-VLOSE);consecutiveP5=0; // tritone = dive + lose speed
    } else if(diff===5){
      rV-=TDOWN;consecutiveP5=0;
    } else consecutiveP5=0;
  }
  lastNote=note;tRise=(note+7)%12;tDive1=(note+5)%12;tDive2=(note+6)%12;
  mt1=HUE[note];mt2=HUE[(note+7)%12];
  document.getElementById('pa').style.background=`linear-gradient(90deg,hsl(${mt1},100%,55%),hsl(${mt2},100%,55%))`;
  document.querySelectorAll('.rb').forEach(b=>b.style.borderColor=`hsl(${mt1},80%,55%)`);
  ripple(sX,sY,HUE[note]);splash(sX,sY,350);
  document.getElementById('hn').innerText=`NOTE: ${NOTE[note]}`;
  document.getElementById('hr').innerText=`P5 RISE → ${NOTE[tRise]}`;
  document.getElementById('hd').innerText=`P4↓ ${NOTE[tDive1]} | TT↓ ${NOTE[tDive2]}`;
  // hard mode beat check
  if(hard){
    const inWin=bt<=bwin||bt>=bi-bwin;
    if(inWin){bstreak++;bhp+=bstreak;bflash=14;document.getElementById('hb').innerText=`BEAT ✓ +${bstreak}`}
    else{bstreak=0;document.getElementById('hb').innerText='MISSED BEAT'}
    bt=0;
  }
}

// ── MAIN LOOP ────────────────────────────────────────────────────────────────
function loop(){
  requestAnimationFrame(loop);frames++;

  // Audio: stable gate
  const raw=mic.read();
  if(raw>=0){silF=0;if(raw===cand){candF++;if(candF>=NOTE_HOLD&&raw!==lastNote&&state!=='DEAD')onNote(raw)}else{cand=raw;candF=1}}
  else{silF++;if(silF>SIL_RST){lastNote=-1;cand=-1;candF=0}}

  // Hard mode beat
  if(hard&&state==='ORBITING'){bt++;if(bt>=bi){bcount++;bt=0;oSpd=Math.max(VMIN,oSpd*.9985)}}

  // Munker lerp
  mh1=lh(mh1,mt1,.04);mh2=lh(mh2,mt2,.04);sHue=lh(sHue,lastNote>=0?HUE[lastNote]:sHue,.06);

  ctx.clearRect(0,0,W,H);
  if(frames%4===0)stepRuliad();drawRuliad(lastNote);
  if(frames%3===0)drawStars(lastNote);
  drawWave();

  // Boundary rings
  ctx.strokeStyle='rgba(0,255,65,.1)';ctx.lineWidth=1;ctx.setLineDash([4,8]);
  ctx.beginPath();ctx.arc(cx,cy,minR+10,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,maxR-10,0,Math.PI*2);ctx.stroke();
  ctx.setLineDash([]);

  // Sun position
  sX=cx+Math.cos(oA)*oR;sY=cy+Math.sin(oA)*oR;

  if(state==='ORBITING'&&frames%150===0)spawnMeteor();
  drawMeteors();

  // Physics
  if(state==='ORBITING'){
    rV-=grav;rV*=DAMP;oR+=rV;
    const prev=oA;oA+=oSpd;
    if(Math.floor(prev/(Math.PI*2))<Math.floor(oA/(Math.PI*2))){days++;document.getElementById('sc').innerText=days;oSpd+=.0003;grav+=.0008}
    if(oR<=minR)die('CRASHED INTO EARTH!');if(oR>=maxR)die('LOST IN DEEP SPACE!');
  }

  // Velocity HUD
  document.getElementById('hv').innerText=`SPD:${oSpd.toFixed(4)} VEL:${rV.toFixed(2)}`;

  // Orbit trail
  if(state==='ORBITING'){for(let i=1;i<=5;i++){const ta=oA-i*.07,tx=cx+Math.cos(ta)*oR,ty=cy+Math.sin(ta)*oR;ctx.fillStyle=`hsla(${sHue},90%,65%,${.55/i})`;ctx.fillRect(tx-2,ty-2,4-i,4-i)}}

  drawTrajectory();
  drawRipples();
  planet(ctx,cx,cy,ER,'#606060','#909090',4);
  planet(ctx,sX,sY,SR,`hsl(${sHue},70%,60%)`,`hsl(${sHue},90%,80%)`,3);
  drawBeat();
  if(frames%2===0)drawMunker(mh1,mh2,.52);
}

resize();loop();
</script>
</body>
</html>
