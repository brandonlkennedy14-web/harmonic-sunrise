<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Harmonic Sunrise</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono&display=swap');
        body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Space Mono', monospace; overflow: hidden; touch-action: manipulation; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* Fixed UI Overlap - 110px padding */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 110px 20px 20px 20px; box-sizing: border-box; pointer-events: none; }
        
        .hud { text-shadow: 2px 2px 0 #000; font-size: 12px; pointer-events: auto; display: flex; justify-content: space-between; width: 100%; }
        .title { font-size: 20px; font-weight: bold; color: #ff8c00; letter-spacing: 2px; }
        .subtitle { color: #aaa; font-size: 10px; margin-top: 5px; }

        .score-display { font-size: 24px; color: #0f0; font-weight: bold; text-align: right; }
        
        .controls { display: flex; justify-content: flex-start; width: 100%; pointer-events: auto; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        button, .btn-link { background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff; padding: 10px 15px; font-family: 'Space Mono', monospace; font-size: 10px; cursor: pointer; text-transform: uppercase; transition: all 0.2s; text-decoration: none; display: inline-block; box-sizing: border-box; }
        button:active, .btn-link:active { transform: translate(2px, 2px); }

        #btn-mic { border-color: #0f0; color: #0f0; }

        .hud-ratios { margin-top: 15px; font-size: 12px; }
        .ratio-box { padding: 8px; border-left: 3px solid #fff; margin-bottom: 8px; background: rgba(0,0,0,0.7); }
    </style>
</head>
<body>

    <div id="global-nav" style="position: absolute; top: 0; left: 0; width: 100%; z-index: 100; display: flex; justify-content: center; gap: 10px; padding: 15px 5px; background: rgba(0,0,0,0.85); border-bottom: 2px solid #333; pointer-events: auto; font-family: 'Space Mono', monospace; box-sizing: border-box; flex-wrap: wrap; font-size: 12px;">
        <a href="index.html" style="color: #ff8c00; text-decoration: none; font-weight: bold;">[1] SUNRISE</a> <span style="color: #555;">|</span>
        <a href="flappy.html" style="color: #00ffcc; text-decoration: none; font-weight: bold;">[2] FLAPPY</a> <span style="color: #555;">|</span>
        <a href="billiards.html" style="color: #ff00ff; text-decoration: none; font-weight: bold;">[3] WINDING</a> <span style="color: #555;">|</span>
        <a href="invaders.html" style="color: #ff0055; text-decoration: none; font-weight: bold;">[4] INVADERS</a> <span style="color: #555;">|</span>
        <a href="weaver.html" style="color: #b366ff; text-decoration: none; font-weight: bold;">[5] WEAVER</a> <span style="color: #555;">|</span>
        <a href="simon.html" style="color: #fff; text-decoration: none; font-weight: bold;">[6] SIMON</a>
    </div>

    <canvas id="c-main"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <div>
                <div class="title">HARMONIC SUNRISE</div>
                <div class="subtitle" id="status-text">STATUS: AWAITING AUDIO...</div>

                <div class="hud-ratios">
                    <div class="ratio-box" id="hud-last" style="border-color: #fff;">LAST NOTE: --</div>
                    <div class="ratio-box" id="hud-rise" style="border-color: #0f0; color: #0f0;">RISE (P5): --</div>
                    <div class="ratio-box" id="hud-dawn" style="border-color: #ff0055; color: #ff0055;">DAWN (P4/TT): --</div>
                    <div class="ratio-box" id="hud-phase" style="border-color: #00ffcc; color: #00ffcc; margin-top: 15px;">PHASE: GROUNDED</div>
                </div>
            </div>
            <div>
                <div class="subtitle" style="text-align: right;">SCORE</div>
                <div class="score-display" id="score-text">0</div>
            </div>
        </div>

        <div class="controls">
            <button id="btn-mic">START MIC</button>
            <button id="btn-vision">VISUAL: ORGANIC</button>
            <a href="https://buymeacoffee.com/brandonkennedy" target="_blank" class="btn-link" style="border-color: #ffd700; color: #ffd700;">BUY ME A COFFEE</a>
        </div>
    </div>

<script type="module">
    import { AudioEngine } from './audio.js';
    import { notes, hzToPitchClass } from './theory.js';

    const canvas = document.getElementById('c-main');
    const ctx = canvas.getContext('2d');
    const audio = new AudioEngine();

    const btnMic = document.getElementById('btn-mic');
    const btnVision = document.getElementById('btn-vision');
    
    let viewMode = 'ORGANIC';
    let score = 0;

    // Logic Variables
    let lastPlayedNote = -1;
    let targetRise = -1;
    let targetDawn1 = -1; // Perfect 4th
    let targetDawn2 = -1; // Tritone
    
    // Physics Variables
    let sunTargetHeight = 0;
    let sunCurrentHeight = 0;
    let maxSunHeight = 0;
    let orbitAngle = 0;

    function resize() { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight; 
        maxSunHeight = canvas.height - 150;
    }
    window.addEventListener('resize', resize); resize();

    btnMic.addEventListener('click', async () => {
        if (await audio.startMic()) {
            btnMic.style.display = 'none';
            document.getElementById('status-text').innerText = "STATUS: PLAY A BASELINE NOTE"; 
        }
    });

    btnVision.addEventListener('click', () => {
        if (viewMode === 'ORGANIC') {
            viewMode = 'SCIENCE';
            btnVision.innerText = 'VISUAL: SCIENCE';
        } else {
            viewMode = 'ORGANIC';
            btnVision.innerText = 'VISUAL: ORGANIC';
        }
    });

    function updateHUD() {
        document.getElementById('score-text').innerText = score;

        if (lastPlayedNote === -1) {
            document.getElementById('hud-last').innerText = "LAST NOTE: --";
            document.getElementById('hud-rise').innerText = "RISE (P5): --";
            document.getElementById('hud-dawn').innerText = "DAWN (P4/TT): --";
        } else {
            document.getElementById('hud-last').innerText = `LAST NOTE: ${notes[lastPlayedNote]}`;
            document.getElementById('hud-rise').innerText = `RISE (P5): ${notes[targetRise]}`;
            document.getElementById('hud-dawn').innerText = `DAWN (P4/TT): ${notes[targetDawn1]} or ${notes[targetDawn2]}`;
        }

        let phase = document.getElementById('hud-phase');
        if (sunTargetHeight <= 0) { phase.innerText = "PHASE: GROUNDED"; phase.style.color = "#ff0055"; }
        else if (sunTargetHeight >= maxSunHeight) { phase.innerText = "PHASE: ORBIT ACHIEVED"; phase.style.color = "#00ffcc"; }
        else { phase.innerText = "PHASE: LIFTING"; phase.style.color = "#ff8c00"; }
    }

    function renderFrame() {
        requestAnimationFrame(renderFrame); 

        // Smooth physics interpolation
        sunCurrentHeight += (sunTargetHeight - sunCurrentHeight) * 0.05;

        // Background
        if (viewMode === 'ORGANIC') {
            let skyGlow = Math.min(1, sunCurrentHeight / maxSunHeight);
            ctx.fillStyle = `rgb(${10 + skyGlow*40}, ${0 + skyGlow*20}, ${20 + skyGlow*50})`;
        } else {
            ctx.fillStyle = '#050505';
        }
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let cx = canvas.width / 2; 
        let cy = canvas.height / 2;

        // --- AUDIO LOGIC ---
        if (audio.isRunning) {
            let peaks = audio.getPeaks(95);
            if (peaks.length > 0) {
                let currentNote = hzToPitchClass(peaks[0].hz);
                
                if (currentNote !== -1 && currentNote !== lastPlayedNote) {
                    if (lastPlayedNote === -1) {
                        // Initialize first note
                        lastPlayedNote = currentNote;
                        document.getElementById('status-text').innerText = "STATUS: TRACKING INTERVALS"; 
                    } else {
                        // Check interval logic based on user rules
                        let diff = (currentNote - lastPlayedNote + 12) % 12;
                        
                        if (diff === 7) { // Perfect 5th -> RISE
                            sunTargetHeight += 60;
                            score += 10;
                        } else if (diff === 5 || diff === 6) { // P4 or Tritone -> DAWN
                            sunTargetHeight -= 60;
                            score = Math.max(0, score - 5);
                        }

                        // Clamp sun height
                        sunTargetHeight = Math.max(0, Math.min(sunTargetHeight, maxSunHeight));
                        lastPlayedNote = currentNote; // Shift baseline
                    }

                    // Calculate new targets
                    targetRise = (lastPlayedNote + 7) % 12;
                    targetDawn1 = (lastPlayedNote + 5) % 12; // P4
                    targetDawn2 = (lastPlayedNote + 6) % 12; // Tritone
                    
                    updateHUD();
                }
            }
        }

        // --- VISUAL RENDERING ---
        if (viewMode === 'ORGANIC') {
            // Draw Earth
            ctx.shadowBlur = 30; ctx.shadowColor = '#0055ff'; ctx.fillStyle = '#1e90ff';
            ctx.beginPath(); ctx.arc(cx, canvas.height - 30, 40, Math.PI, 0); ctx.fill(); ctx.shadowBlur = 0;

            // Draw Sun
            let sunY = canvas.height - 30 - sunCurrentHeight;
            let isOrbiting = sunCurrentHeight >= maxSunHeight - 5;

            if (isOrbiting) {
                orbitAngle += 0.02;
                let orbitRadius = maxSunHeight * 0.4;
                cx = canvas.width/2 + Math.cos(orbitAngle) * orbitRadius;
                sunY = (canvas.height - 30 - maxSunHeight) + Math.sin(orbitAngle) * (orbitRadius * 0.5);
            }

            ctx.shadowBlur = 50; ctx.shadowColor = '#ff8c00'; ctx.fillStyle = '#ffaa00'; 
            ctx.beginPath(); ctx.arc(cx, sunY, 25, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;

        } else if (viewMode === 'SCIENCE') {
            // Science View - Circular Interval Map
            let radius = Math.min(canvas.width, canvas.height) * 0.35;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.stroke();

            for (let i = 0; i < 12; i++) {
                let angle = (i * Math.PI / 6) - (Math.PI / 2);
                let x = cx + Math.cos(angle) * radius;
                let y = cy + Math.sin(angle) * radius;

                let isLast = (i === lastPlayedNote);
                let isRise = (i === targetRise);
                let isDawn = (i === targetDawn1 || i === targetDawn2);

                if (isLast) { ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#fff'; }
                else if (isRise) { ctx.fillStyle = '#0f0'; ctx.shadowBlur = 10; ctx.shadowColor = '#0f0'; }
                else if (isDawn) { ctx.fillStyle = '#ff0055'; ctx.shadowBlur = 10; ctx.shadowColor = '#ff0055'; }
                else { ctx.fillStyle = '#333'; ctx.shadowBlur = 0; }

                ctx.beginPath(); ctx.arc(x, y, isLast ? 10 : 6, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
                
                ctx.fillStyle = '#aaa'; ctx.font = '12px monospace'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(notes[i], cx + Math.cos(angle) * (radius + 25), cy + Math.sin(angle) * (radius + 25));
            }

            // Draw center height bar
            let barHeight = 200;
            let fillHeight = (sunCurrentHeight / maxSunHeight) * barHeight;
            ctx.strokeStyle = '#333'; ctx.strokeRect(cx - 5, cy - barHeight/2, 10, barHeight);
            ctx.fillStyle = '#ff8c00'; ctx.fillRect(cx - 5, cy + barHeight/2 - fillHeight, 10, fillHeight);
        }
    }
    
    renderFrame();
</script>
</body>
</html>